title: WMI Persistence - Command Line Event Consumer
id: 05936ce2-ee05-4dae-9d03-9a391cf2d2c6
status: test
description: Detects WMI command line event consumers
references:
- https://www.eideon.com/2018-03-02-THL03-WMIBackdoors/
author: Thomas Patzke
date: 2018-03-07
modified: 2021-11-27
tags:
- attack.t1546.003
- attack.persistence
logsource:
  category: image_load
  product: windows
detection:
  selection:
    Image: 'C:\Windows\System32\wbem\WmiPrvSE.exe'
    ImageLoaded|endswith: '\wbemcons.dll'
  condition: selection
falsepositives:
- Unknown (data set is too small; further testing needed)
level: high
notes: |
  n
  ### Technical Context
  This detection rule identifies potentially malicious use of Windows Management Instrumentation (WMI) through the monitoring of command line event consumers. Specifically, it looks for instances where the WMI Provider Host (WmiPrvSE.exe) loads the `wbemcons.dll` library, a behavior often exploited by adversaries for persistence mechanisms on Windows systems. The detection leverages image load events monitored by Sysmon, which captures detailed information about process interactions, including the images being executed and the specific DLLs being loaded. This tactic falls under the MITRE ATT&CK framework, specifically under T1546.003, which deals with the use of WMI for persistence. 
  Adversaries may employ WMI to set up backdoors or to maintain access to compromised systems without detection, making it crucial for incident responders to investigate such alerts quickly and effectively.
  ### Investigation Steps
  - **Check Sysmon Logs**: Review the Sysmon logs for additional events related to process creation and DLL loading. Pay particular attention to the timestamps and user accounts involved for potential indicators of compromise.
  - **Correlate with EDR Data**: Utilize EDR tools to observe the behavior of the `WmiPrvSE.exe` process and assess whether any suspicious commands were executed during its lifecycle.
  - **Inspect Event Viewer**: Look into the Windows Event logs (Security, System) for any unusual activity surrounding the creation of WMI event consumers, especially during off-hours or from unapproved accounts.
  - **Analyze Network Activity**: Use network traffic logs from the NDR and NGFW to identify any outbound connections initiated by the suspected WMI processes. Investigate any connections to known malicious IP addresses or domains.
  ### Prioritization
  Alerts generated by this rule should be considered high severity due to the potential for WMI-related persistence mechanisms, which can enable long-term unauthorized access and control over enterprise systems.
  ### Blind Spots and Assumptions
  This rule may not fire in environments where WMI has been properly secured or where legitimate uses of WMI are prevalent, leading to potential false negatives. Additionally, if adversaries employ custom or less common methods of persistence outside of WMI, these behaviors may evade detection. The monitoring of Sysmon and related logs is also dependent on proper configuration and may not capture all relevant events if not deployed consistently across the environment.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
