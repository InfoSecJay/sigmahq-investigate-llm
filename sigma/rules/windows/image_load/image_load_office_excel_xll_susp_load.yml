title: Microsoft Excel Add-In Loaded From Uncommon Location
id: af4c4609-5755-42fe-8075-4effb49f5d44
related:
- id: c5f4b5cb-4c25-4249-ba91-aa03626e3185
  type: derived
status: test
description: Detects Microsoft Excel loading an Add-In (.xll) file from an uncommon
  location
references:
- https://www.mandiant.com/resources/blog/lnk-between-browsers
- https://wazuh.com/blog/detecting-xll-files-used-for-dropping-fin7-jssloader-with-wazuh/
author: Nasreddine Bencherchali (Nextron Systems)
date: 2023-05-12
tags:
- attack.execution
- attack.t1204.002
logsource:
  category: image_load
  product: windows
detection:
  selection:
    Image|endswith: '\excel.exe'
    ImageLoaded|contains:
            # Note: Add or remove locations from this list based on your internal policy
    - '\Desktop\'
    - '\Downloads\'
    - '\Perflogs\'
    - '\Temp\'
    - '\Users\Public\'
    - '\Windows\Tasks\'
    ImageLoaded|endswith: '.xll'
  condition: selection
falsepositives:
- Some tuning might be required to allow or remove certain locations used by the rule
  if you consider them as safe locations
level: medium
notes: |
  ### Technical Context
  This Sigma rule monitors the loading of Microsoft Excel add-in files (.xll) from uncommon or suspicious locations on a Windows system. It specifically looks for instances where the Excel application (excel.exe) loads an add-in file located in directories that are not typically associated with legitimate user activity, such as Desktop, Downloads, Temp, and public directories. The rule utilizes the image load logging capability provided by Windows, tapping into event logs to identify processes that may be executing potentially malicious code indirectly via these add-ins. By flagging this behavior, the rule aims to identify activities that could align with malicious tactics related to user execution (MITRE ATT&CK Tactic: Execution, Technique: T1204.002 â€“ Malicious File Execution).
  ### Investigation Steps
  - **Check Process Context:** Utilize EDR tools to obtain the full context of the `excel.exe` process. Look for any other suspicious command-line arguments or parent processes that may indicate a malicious payload.
  - **Examine Recent Activity:** Review the Windows Event Logs for any recent user activity related to the installations or downloads of files in the flagged locations. Identify if unusual patterns or behavior precede the execution of Excel.
  - **Analyze Loaded Add-Ins:** Investigate the specific add-in (.xll) being loaded, looking it up in threat intelligence databases to ascertain if it has been previously reported as malicious or linked to known attacks.
  - **Monitor Network Traffic:** Leverage network detection tools and logs to monitor for any unusual outbound connections made by `excel.exe` or any processes that forked from it, indicating potential command-and-control communication.
  ### Prioritization
  The alert generated by this rule is assigned a medium severity level due to the potential risk associated with loading files from uncommon locations, which can be an entry point for malicious activity. This suggests a need for investigation to confirm the legitimacy of the file and collect context before escalating as a full incident.
  ### Blind spots and Assumptions
  This rule may fail to fire if an adversary is able to load malicious add-ins from standard or whitelisted locations that are not flagged by the current configuration. Additionally, legitimate users might occasionally store add-ins in these directories for convenience, leading to false positives. The effectiveness of this rule assumes that users do not regularly download or execute add-ins from these uncommon paths as part of their normal workflow, which might not always hold true in varied enterprise environments.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
