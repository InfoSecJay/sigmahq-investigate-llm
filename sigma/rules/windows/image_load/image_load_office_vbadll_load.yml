title: VBA DLL Loaded Via Office Application
id: e6ce8457-68b1-485b-9bdd-3c2b5d679aa9
status: test
description: Detects VB DLL's loaded by an office application. Which could indicate
  the presence of VBA Macros.
references:
- https://medium.com/threatpunter/detecting-adversary-tradecraft-with-image-load-event-logging-and-eql-8de93338c16
author: Antonlovesdnb
date: 2020-02-19
modified: 2023-02-10
tags:
- attack.execution
- attack.t1204.002
logsource:
  category: image_load
  product: windows
detection:
  selection:
    Image|endswith:
    - '\excel.exe'
    - '\mspub.exe'
    - '\onenote.exe'
    - '\onenoteim.exe'         # Just in case
    - '\outlook.exe'
    - '\powerpnt.exe'
    - '\winword.exe'
    ImageLoaded|endswith:
    - '\VBE7.DLL'
    - '\VBEUI.DLL'
    - '\VBE7INTL.DLL'
  condition: selection
falsepositives:
- Legitimate macro usage. Add the appropriate filter according to your environment
level: high
notes: |
  n
  ### Technical Context
  This detection rule focuses on identifying potential malicious behavior involving Visual Basic for Applications (VBA) by monitoring for specific Dynamic Link Libraries (DLLs) loaded within Microsoft Office applications. It primarily looks for instances where the `VBE7.DLL`, `VBEUI.DLL`, or `VBE7INTL.DLL` libraries are loaded by Microsoft Office processes such as Excel, Word, PowerPoint, Outlook, and others. This could indicate that VBA macros are being executed, which is a common method for attackers to deliver payloads, steal data, or establish persistence on compromised systems. The rule leverages image load event logs which capture the libraries loaded by processes, providing data on the behavior of applications during execution. This aligns with the MITRE ATT&CK tactic of Execution and specifically with technique T1204.002: Malicious File Execution.
  ### Investigation Steps
  - **Review EDR Alerts:** Check EDR logs for any alerts related to the identified Office applications and examine the process tree to understand the origin and context of the loaded DLLs.
  - **Analyze Windows Event Logs:** Look into Windows Security event logs for any suspicious user activities correlating with the time of the alert, specifically focusing on User logon attempts and Office application usage.
  - **Evaluate Network Activity:** Use Network Detection and Response (NDR) tools to investigate any outbound connections initiated around the same time the alert was triggered, checking for unusual or unauthorized destinations.
  - **Inspect Office Document Metadata:** If the Office application opened a document, review the file properties and metadata for indicators of compromise, such as unexpected authors, modification dates, or history of access.
  ### Prioritization
  The alert generated by this rule is considered high severity due to the potential risks associated with executing unauthorized VBA macros, which can lead to data breaches, system compromise, or malware deploymentâ€”commonly leveraged tactics among adversaries.
  ### Blind Spots and Assumptions
  This rule may not fire for systems where legitimate VBA macro usage occurs regularly without security filters in place. Additionally, environments with heavily restricted user privileges or those that have disabled macros in Office applications could lead to missed detections. Lastly, adversaries may employ obfuscation techniques or utilize alternative execution paths that do not trigger this rule.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
