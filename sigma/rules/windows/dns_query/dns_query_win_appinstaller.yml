title: AppX Package Installation Attempts Via AppInstaller.EXE
id: 7cff77e1-9663-46a3-8260-17f2e1aa9d0a
related:
- id: 180c7c5c-d64b-4a63-86e9-68910451bc8b
  type: derived
status: test
description: |
  Detects DNS queries made by "AppInstaller.EXE". The AppInstaller is the default handler for the "ms-appinstaller" URI. It attempts to load/install a package from the referenced URL
references:
- https://twitter.com/notwhickey/status/1333900137232523264
- https://lolbas-project.github.io/lolbas/Binaries/AppInstaller/
author: frack113
date: 2021-11-24
modified: 2023-11-09
tags:
- attack.command-and-control
- attack.t1105
logsource:
  product: windows
  category: dns_query
detection:
  selection:
    Image|startswith: 'C:\Program Files\WindowsApps\Microsoft.DesktopAppInstaller_'
    Image|endswith: '\AppInstaller.exe'
  condition: selection
falsepositives:
- Unknown
level: medium
notes: |
  n
  ### Technical Context
  The Sigma rule titled "AppX Package Installation Attempts Via AppInstaller.EXE" is designed to detect potentially suspicious DNS queries made by the `AppInstaller.exe` application on Windows systems. The `AppInstaller.exe` is a built-in Microsoft utility responsible for handling app installation requests through the "ms-appinstaller" URI, which can be used for legitimate software installations. However, this functionality can also be exploited by adversaries to install malicious software under the guise of legitimate application installation. 
  This detection rule focuses on the process creation logs that specifically look for instances of the `AppInstaller.exe` application originating from the default path within the WindowsApps directory. By monitoring DNS queries generated by this executable, the rule aims to identify any unusual or unauthorized installation attempts that could comprise a command-and-control (C2) activity, corresponding to the MITRE ATT&CK tactic of Command and Control (T1105).
  ### Investigation Steps
  - **Review EDR Alerts:** Examine endpoint detection and response (EDR) alerts for any unusual activity related to `AppInstaller.exe`. Cross-reference the associated DNS queries with known malicious domains to identify potential threats.
  - **Analyze DNS Logs:** Check DNS logs for queries generated by `AppInstaller.exe`. Determine if these queries attempt to resolve to unrecognized or suspicious domains that are not part of trusted software repositories. 
  - **Validate DNS Responses:** Analyze the DNS responses for anomalies, such as unexpected records or IP addresses that do not match with known application installation providers. Consider checking against threat intelligence databases for the domains involved.
  - **Assess User Context:** Investigate the context around the user account that initiated the `AppInstaller.exe` process. Ensure that there are no indicators of compromise in user behavior or whether the application was launched in an inappropriate context.
  ### Prioritization
  Given the nature of potential abuse of the `AppInstaller.exe`, alerts generated by this rule should be treated with medium severity. Although the application serves legitimate purposes, any detected usage could indicate an effort to deploy malware or unauthorized software within the enterprise environment.
  ### Blind Spots and Assumptions
  This rule assumes that all installations of applications via `AppInstaller.exe` are logged correctly and that no legitimate applications are being installed remotely in a controlled manner. It's possible that environments with heavy use of application virtualizations or similar tools might bypass these logs. Additionally, the rule may not detect internal processes if `AppInstaller.exe` is misused without generating DNS queries, or if DNS traffic does not pass through monitored channels, which adversaries could exploit.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
