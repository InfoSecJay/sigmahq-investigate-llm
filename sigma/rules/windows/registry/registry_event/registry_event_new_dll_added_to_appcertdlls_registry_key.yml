title: New DLL Added to AppCertDlls Registry Key
id: 6aa1d992-5925-4e9f-a49b-845e51d1de01
status: test
description: |
  Dynamic-link libraries (DLLs) that are specified in the AppCertDLLs value in the Registry key can be abused to obtain persistence and privilege escalation
  by causing a malicious DLL to be loaded and run in the context of separate processes on the computer.
references:
- http://www.hexacorn.com/blog/2013/01/19/beyond-good-ol-run-key-part-3/
- https://eqllib.readthedocs.io/en/latest/analytics/14f90406-10a0-4d36-a672-31cabe149f2f.html
author: Ilyas Ochkov, oscd.community
date: 2019-10-25
modified: 2021-11-27
tags:
- attack.persistence
- attack.t1546.009
logsource:
  category: registry_event
  product: windows
detection:
  selection:
        # Sysmon gives us HKLM\SYSTEM\CurrentControlSet\.. if ControlSetXX is the selected one
  - TargetObject: 'HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\AppCertDlls'
        # key rename
  - NewName: 'HKLM\SYSTEM\CurentControlSet\Control\Session Manager\AppCertDlls'
  condition: selection
fields:
- EventID
- Image
- TargetObject
- NewName
falsepositives:
- Unknown
level: medium
notes: |
  n
  ### Technical Context
  The Sigma rule for detecting the addition of a new DLL to the AppCertDlls registry key is designed to identify potential persistence and privilege escalation techniques used by adversaries. Specifically, this rule monitors changes to the `AppCertDlls` registry key located at `HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\AppCertDlls`. When a new dynamic-link library (DLL) is registered in this key, it can be used by malware to execute code in the context of various processes, making it an effective vector for stealthy persistence. The primary data sources utilized by this rule include Windows Security logs for registry events and Sysmon logs that provide insights into registry changes.
  This detection aligns with the MITRE ATT&CK framework under the "Persistence" tactic (TA0003) and specifically targets technique T1546.009, which encompasses various methods adversaries use to maintain access, including modifications to system components like DLLs. 
  ### Investigation Steps
  - **Review Registry Changes:** Examine the Windows Security logs and Sysmon logs for any recent changes to the `AppCertDlls` registry key, noting any unusual DLL names or paths.
  - **Check Process Activity:** Use EDR tools to investigate the processes that have been loaded since the registry modification occurred, specifically looking for any unfamiliar or suspicious processes linked to the newly added DLL.
  - **Analyze Network Connections:** Review network connection logs to identify any communications initiated by the processes that loaded the newly registered DLL, assessing whether those connections encapsulate malicious behavior.
  - **Correlate with User Activity:** Utilize application logs and authentication records to correlate the timing of the registry modification with user logins and application usage, ensuring that there aren't legitimate explanations for the DLL addition.
  ### Prioritization
  Alerts generated by this rule should be treated with medium severity as the addition of a DLL to the AppCertDlls registry can signify advanced persistent threats attempting to maintain footholds within the enterprise environment. However, context and correlation with additional data sources are necessary to determine the true risk and enable appropriate responses.
  ### Blind Spots and Assumptions
  One potential blind spot for this rule is the reliance on registry event logging; if logging is disabled or misconfigured, related events may not be captured, resulting in missed detections. Another assumption is that the threat actor's method of persistence is consistent with known patterns; however, advanced adversaries may use obfuscation or less common techniques to evade detection. Furthermore, if a legitimate application updates its DLL in this manner, it could lead to false positives unless further contextual investigation is conducted.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
