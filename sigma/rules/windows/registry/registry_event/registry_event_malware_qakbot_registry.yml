title: Potential Qakbot Registry Activity
id: 1c8e96cd-2bed-487d-9de0-b46c90cade56
status: test
description: Detects a registry key used by IceID in a campaign that distributes malicious
  OneNote files
references:
- https://www.zscaler.com/blogs/security-research/onenote-growing-threat-malware-distribution
author: Hieu Tran
date: 2023-03-13
tags:
- attack.defense-evasion
- attack.t1112
logsource:
  category: registry_event
  product: windows
detection:
  selection:
    TargetObject|endswith: '\Software\firm\soft\Name'
  condition: selection
falsepositives:
- Unknown
level: high
notes: |
  ### Technical Context
  The Sigma rule titled "Potential Qakbot Registry Activity" is designed to detect specific registry modifications that are characteristic of the Qakbot malware, particularly in campaigns that distribute malicious OneNote files. This rule specifically monitors registry events to look for the creation or modification of a registry key that ends with `\Software\firm\soft\Name`. The identification of this registry key is tied to the behavior of the Qakbot malware, which often employs sophisticated evasion techniques. 
  The detection leverages Windows Registry events, as captured by the operating systemâ€™s logging capabilities. These logs provide critical visibility into changes made to the registry, which can be indicative of malicious activity. The rule is associated with the MITRE ATT&CK technique T1112 (Modify Registry), which outlines how attackers may manipulate the Windows registry to achieve defense evasion or maintain persistence within an environment.
  ### Investigation Steps
  - **Check EDR Alerts:** Review endpoint detection and response (EDR) alerts for any processes that might have accessed or modified the targeted registry key, paying close attention to the surrounding process tree and timestamps.
  - **Correlate with Process Creation Logs:** Inspect Windows event logs related to process creation for anomalies or suspicious behavior around the time the registry change occurred. Filtering by high-risk processes may help identify potential compromise.
  - **Review Network Traffic:** Utilize network detection and response (NDR) tools to analyze outbound connections made by the endpoint where the registry change was detected, checking for any connections to known malicious IPs or domains linked to Qakbot.
  - **Investigate Related Files:** Examine the file activity on the affected machine, particularly looking for any OneNote files or other associated artifacts that might be related to the registry change, along with their execution history.
  ### Prioritization
  This alert is categorized as high severity due to the potential impact of the Qakbot malware, which typically aims to establish persistence, gather sensitive information, and further propagate within the network. Rapid investigation and response are crucial to mitigate potential breaches.
  ### Blind Spots and Assumptions
  This detection rule may not trigger in environments where the targeted registry modification is not logged due to insufficient audit policies being enabled on Windows machines. Additionally, if an adversary employs methods to obfuscate or modify their behavior, such as changing the registry key to another name or using legitimate software to make modifications, the rule could fail to catch such activities. It operates under the assumption that the registry activity is indicative of malicious intent; thus, those who implement and review these logs should remain vigilant for false negatives.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality and relevance, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
