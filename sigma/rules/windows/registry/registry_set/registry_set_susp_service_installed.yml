title: Suspicious Service Installed
id: f2485272-a156-4773-82d7-1d178bc4905b
status: test
description: |
  Detects installation of NalDrv or PROCEXP152 services via registry-keys to non-system32 folders.
  Both services are used in the tool Ghost-In-The-Logs (https://github.com/bats3c/Ghost-In-The-Logs), which uses KDU (https://github.com/hfiref0x/KDU)
references:
- https://web.archive.org/web/20200419024230/https://blog.dylan.codes/evading-sysmon-and-windows-event-logging/
author: xknow (@xknow_infosec), xorxes (@xor_xes)
date: 2019-04-08
modified: 2023-08-17
tags:
- attack.t1562.001
- attack.defense-evasion
logsource:
  category: registry_set
  product: windows
detection:
  selection:
    TargetObject:
    - 'HKLM\System\CurrentControlSet\Services\NalDrv\ImagePath'
    - 'HKLM\System\CurrentControlSet\Services\PROCEXP152\ImagePath'
  filter:
    Image|endswith:
            # Please add the full paths that you use in your environment to tighten the rule
    - '\procexp64.exe'
    - '\procexp.exe'
    - '\procmon64.exe'
    - '\procmon.exe'
    - '\handle.exe'
    - '\handle64.exe'
    Details|contains: '\WINDOWS\system32\Drivers\PROCEXP152.SYS'
  condition: selection and not filter
falsepositives:
- Other legimate tools using this service names and drivers. Note - clever attackers
  may easily bypass this detection by just renaming the services. Therefore just Medium-level
  and don't rely on it.
level: medium
notes: |
  n
  ### Technical Context
  The "Suspicious Service Installed" detection rule is designed to identify the installation of specific services, namely NalDrv and PROCEXP152, through changes made in the Windows registry. These services are associated with the tool Ghost-In-The-Logs, which is known for its use in evading detection and maintaining persistence within a compromised environment. The rule targets specific registry keys that correspond to the service installation paths, specifically looking for modifications that do not conform to normal system folder locations, such as non-system32 directories. This detection is aligned with the MITRE ATT&CK technique T1562.001 (Impair Defenses: Disable Security Tools), as it focuses on the circumvention of security measures through suspicious service installations. The primary data source used in this rule is the Windows registry, specifically monitoring events related to the creation or modification of service-related keys.
  ### Investigation Steps
  - **Use EDR Tools:** Investigate the host where the alert was generated using your Endpoint Detection and Response (EDR) tool to examine the list of installed services and identify any abnormal entries.
  - **Check Registry Logs:** Query the Windows registry for changes to the specified paths that may indicate unauthorized modifications or service installations, focusing on the specific keys identified in the detection rule.
  - **Analyze Process Activity:** Utilize Sysmon logs to observe process creation events related to the suspicious services, checking for any accompanying command-line arguments or parent processes that may indicate unauthorized usage.
  - **Review File Locations:** Conduct a review of the file paths for the executables listed in the rule, ensuring that they are located in their expected directories to rule out any potential misuse or evasion tactics used by the adversary.
  ### Prioritization
  Due to the potential for these services to be utilized in evading security controls and for persistence, any alerts generated by this rule should be treated with medium priority. Investigations should be conducted promptly to determine if they indicate a compromise or legitimate software.
  ### Blind Spots and Assumptions
  This rule may not fire in scenarios where the attacker renames the services or utilizes alternative deployment methods that do not modify the specific registry keys targeted. Additionally, false positives may occur if legitimate applications use similar service names, which necessitates careful investigation prior to escalation. Analysts should be aware that clever adversaries can exploit service names and paths to evade detection mechanisms.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
