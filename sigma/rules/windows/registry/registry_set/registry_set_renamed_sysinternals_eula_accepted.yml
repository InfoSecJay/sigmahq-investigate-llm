title: Usage of Renamed Sysinternals Tools - RegistrySet
id: 8023f872-3f1d-4301-a384-801889917ab4
related:
- id: 25ffa65d-76d8-4da5-a832-3f2b0136e133
  type: derived
- id: f50f3c09-557d-492d-81db-9064a8d4e211
  type: similar
status: test
description: Detects non-sysinternals tools setting the "accepteula" key which normally
  is set on sysinternals tool execution
references:
- Internal Research
author: Nasreddine Bencherchali (Nextron Systems)
date: 2022-08-24
modified: 2023-08-17
tags:
- attack.resource-development
- attack.t1588.002
logsource:
  product: windows
  category: registry_set
detection:
  selection:
    TargetObject|contains:
    - '\PsExec'
    - '\ProcDump'
    - '\Handle'
    - '\LiveKd'
    - '\Process Explorer'
    - '\PsLoglist'
    - '\PsPasswd'
    - '\Active Directory Explorer'
    TargetObject|endswith: '\EulaAccepted'
  filter_main_image_names:
    Image|endswith:
    - '\PsExec.exe'
    - '\PsExec64.exe'
    - '\procdump.exe'
    - '\procdump64.exe'
    - '\handle.exe'
    - '\handle64.exe'
    - '\livekd.exe'
    - '\livekd64.exe'
    - '\procexp.exe'
    - '\procexp64.exe'
    - '\psloglist.exe'
    - '\psloglist64.exe'
    - '\pspasswd.exe'
    - '\pspasswd64.exe'
    - '\ADExplorer.exe'
    - '\ADExplorer64.exe'
  filter_optional_null:
    Image:          # Race condition with some logging tools
  condition: selection and not 1 of filter_main_* and not 1 of filter_optional_*
falsepositives:
- Unlikely
level: high
notes: |
  ### Technical Context
  This Sigma rule identifies suspicious activity related to the unauthorized usage of renamed Sysinternals tools leveraging registry manipulations. Specifically, it focuses on detecting instances where non-Sysinternals tools attempt to set the registry key "EulaAccepted," a key that is typically modified during the execution of legitimate Sysinternals utilities such as PsExec or Process Explorer. The detection mechanism works by monitoring registry events where specific target objects match patterns associated with these tools. Additionally, the rule verifies that the image running the process corresponds to known Sysinternals executables by matching the file names against a predefined list. This behavior aligns with the MITRE ATT&CK technique for Resource Development (T1588.002), where attackers may use legitimate tools to mask their activities or to ensure an environment is appropriately configured for future exploitation.
  ### Investigation Steps
  - **Review EDR Alerts**: Examine any alerts generated by the EDR regarding suspicious registry modifications. Look for any registry keys altered by unauthorized processes that are not traditionally associated with Sysinternals tools.
  - **Correlate with System Logs**: Check Windows Security, System, or Application event logs around the time of the alert to identify the process that executed the registry modification. This may provide context for the source of the activity.
  - **Analyze Endpoint Activity**: Utilize the EDR to perform a detailed investigation of the endpoint activity, focusing on the process tree to see if legitimate Sysinternals tools or unauthorized processes initiated the registry changes.
  - **Check for Unusual Network Connections**: If the suspicious behavior is linked to potentially malicious activity, inspect network logs (from NDR or NGFW) for any unusual outbound connections made by the processes involved.
  ### Prioritization
  This alert is categorized as high severity due to the potential for attackers to misuse legitimate tools for malicious purposes, indicating a probable security incident that requires immediate investigation to prevent further exploitation.
  ### Blind Spots and Assumptions
  Detection may miss cases where renamed Sysinternals tools do not modify the expected registry keys or where logs are not adequately generated by certain operations. Additionally, it assumes that all renamed tools will follow similar patterns and that they will not employ methods to bypass detection entirely, such as directly modifying memory instead of the registry. Adversaries could use custom renamed tools that do not match the signatures defined in this rule, thus evading detection.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
