title: Windows Pcap Drivers
id: 7b687634-ab20-11ea-bb37-0242ac130002
status: test
description: Detects Windows Pcap driver installation based on a list of associated
  .sys files.
references:
- https://ragged-lab.blogspot.com/2020/06/capturing-pcap-driver-installations.html#more
author: Cian Heasley
date: 2020-06-10
modified: 2023-04-14
tags:
- attack.discovery
- attack.credential-access
- attack.t1040
logsource:
  product: windows
  service: security
  definition: The 'System Security Extension' audit subcategory need to be enabled
    to log the EID 4697
detection:
  selection:
    EventID: 4697
    ServiceFileName|contains:
    - 'pcap'
    - 'npcap'
    - 'npf'
    - 'nm3'
    - 'ndiscap'
    - 'nmnt'
    - 'windivert'
    - 'USBPcap'
    - 'pktmon'
  condition: selection
fields:
- EventID
- ServiceFileName
- Account_Name
- Computer_Name
- Originating_Computer
- ServiceName
falsepositives:
- Unknown
level: medium
notes: |
  ### Technical Context
  This Sigma rule detects the installation of Windows Packet Capture (Pcap) drivers by monitoring specific system events related to service creation. The rule focuses on Event ID 4697, which logs instances of a service being installed, specifically looking for driver files associated with packet capturing such as 'pcap', 'npcap', 'npf', and others listed in the detection criteria. These drivers can be used both for legitimate purposes, such as network analysis, and by malicious actors to intercept network traffic, making them a vital element for credentials and sensitive data capture. The data sources leveraged are primarily the Windows Security logs, which must have the 'System Security Extension' audit subcategory enabled to capture the relevant events. This detection aligns with the MITRE ATT&CK framework's Discovery tactic (T1040: Network Sniffing) and Credential Access technique.
  ### Investigation Steps
  - **Review Event Logs:** Check Windows Security logs for Event ID 4697 and examine the ServiceFileName to confirm any suspicious Pcap driver installations. Cross-reference the Account_Name and Computer_Name for unusual user behavior or unauthorized systems.
  - **Correlate with EDR Data:** Use your enterprise EDR solution to look for related process activities that coincide with the time of the driver installation and investigate any associated processes that may indicate malicious intent.
  - **Network Traffic Analysis:** Analyze network traffic patterns using your Network Detection and Response (NDR) tools to identify any potential data exfiltration or unusual traffic originating from the systems where the suspect drivers are installed.
  - **Audit for Remedial Actions:** Review if appropriate security measures were applied post-installation, such as blocking the driver from executing if it is not recognized as legitimate and ensuring that endpoint protection tools have flagged it accordingly.
  ### Prioritization
  The alert generated by this rule carries a medium severity level as the installation of Pcap drivers can be both legitimate and malicious. In an enterprise context, it warrants prompt investigation to determine the intent behind the installation, especially if it occurs on sensitive systems.
  ### Blind Spots and Assumptions
  This detection rule assumes that the relevant auditing of service installations is enabled in Windows Security. It may fail to fire if the auditing settings are misconfigured or if new malicious Pcap drivers do not match the predefined signatures. Additionally, skilled adversaries might use obfuscation techniques or custom drivers that evade detection. The rule may also miss cases where legitimate installations do not involve any of the specified filenames but could still be malicious in nature.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality and clarity, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
