title: Potential Access Token Abuse
id: 02f7c9c1-1ae8-4c6a-8add-04693807f92f
status: test
description: Detects potential token impersonation and theft. Example, when using
  "DuplicateToken(Ex)" and "ImpersonateLoggedOnUser" with the "LOGON32_LOGON_NEW_CREDENTIALS
  flag".
references:
- https://www.elastic.co/fr/blog/how-attackers-abuse-access-token-manipulation
- https://www.manageengine.com/log-management/cyber-security/access-token-manipulation.html
author: Michaela Adams, Zach Mathis
date: 2022-11-06
modified: 2023-04-26
tags:
- attack.defense-evasion
- attack.privilege-escalation
- attack.t1134.001
- stp.4u
logsource:
  product: windows
  service: security
detection:
  selection:
    EventID: 4624
    LogonType: 9
    LogonProcessName: 'Advapi'
    AuthenticationPackageName: 'Negotiate'
    ImpersonationLevel: '%%1833'     # Impersonation
  condition: selection
falsepositives:
- Anti-Virus
level: medium
notes: |
  ### Technical Context
  The "Potential Access Token Abuse" detection rule is designed to identify potential incidents of access token manipulation within a Windows environment. Specifically, it looks for instances where a user logs on using logon type 9, which is indicative of a service or impersonation logon attempt. The rule focuses on log entries generated by Windows Security event logs, specifically Event ID 4624, and examines fields related to the logon process (namely "Advapi") and the authentication method (here, "Negotiate"). Additionally, it checks for the impersonation level set to '%%1833', indicating that the system is permitting particular elevated actions based on the token's privileges.
  This rule correlates with the MITRE ATT&CK framework techniques under the "Defense Evasion" and "Privilege Escalation" tactics (particularly technique T1134.001), which detail methods adversaries may use to manipulate access tokens in order to evade detection and escalate their privileges within a compromised environment.
  ### Investigation Steps
  - **Check Event Logs:** Investigate the relevant Windows Security logs for Event ID 4624 occurrences, focusing on events with LogonType 9 to verify whether the authentication and impersonation processes align with legitimate use cases.
    
  - **Analyze Process Activity:** Utilize endpoint detection and response (EDR) tools to assess if any processes were spawned after the suspicious logon events, especially those utilizing the Advapi logon process linked to possible impersonation.
  - **Review User Actions:** Examine the user accounts involved in these logon events against historical activity logs to identify any anomalies or evidence of unauthorized behavior indicating potential token theft.
  - **Cross-reference Alerts:** Compare findings from network logs (NDR) and endpoint security tools (AV, EDR) to ascertain if there are related alerts correlating with other suspicious activities, providing broader context to the potential access token abuse.
  ### Prioritization
  Given that access token manipulation can lead to significant unauthorized access and privilege escalation, alerts from this rule are considered medium to high severity. Immediate investigation is warranted to prevent broader compromise within the enterprise environment.
  ### Blind Spots and Assumptions
  This rule may not trigger in scenarios where the access tokens are manipulated without triggering the defined Event ID, such as exploitation via non-standard logon methods or through legitimate system processes not captured by the logs. Additionally, false positives may arise from legitimate activities of anti-virus software, which might also perform similar logon actions that could mimic malicious behavior. Analysts should be cautious of heavy reliance on a single detection rule and should complement this with wider telemetry and contextual data for a thorough investigation.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
