title: Startup/Logon Script Added to Group Policy Object
id: 123e4e6d-b123-48f8-b261-7214938acaf0
status: experimental
description: |
  Detects the modification of Group Policy Objects (GPO) to add a startup/logon script to users or computer objects.
references:
- https://www.elastic.co/guide/en/security/current/startup-logon-script-added-to-group-policy-object.html
author: Elastic, Josh Nickels, Marius RothenbÃ¼cher
date: 2024-09-06
tags:
- attack.privilege-escalation
- attack.t1484.001
- attack.t1547
logsource:
  product: windows
  service: security
  definition: 'The advanced audit policy setting "Object Access > Audit Detailed File
    Share" must be configured for Success/Failure'
detection:
  selection_eventid:
    EventID:
    - 5136
    - 5145
  selection_attributes_main:
    AttributeLDAPDisplayName:
    - 'gPCMachineExtensionNames'
    - 'gPCUserExtensionNames'
    AttributeValue|contains: '42B5FAAE-6536-11D2-AE5A-0000F87571E3'
  selection_attributes_optional:
    AttributeValue|contains:
    - '40B6664F-4972-11D1-A7CA-0000F87571E3'
    - '40B66650-4972-11D1-A7CA-0000F87571E3'
  selection_share:
    ShareName|endswith: '\SYSVOL'
    RelativeTargetName|endswith:
    - '\scripts.ini'
    - '\psscripts.ini'
    AccessList|contains: '%%4417'
  condition: selection_eventid and (all of selection_attributes_* or selection_share)
falsepositives:
- Legitimate execution by system administrators.
level: medium
notes: |
  ### Technical Context
  This Sigma rule is designed to detect potentially malicious modifications made to Group Policy Objects (GPOs) in a Windows environment, specifically targeting the addition of startup or logon scripts. The rule looks for specific Windows Security Event IDs (5136 and 5145) that indicate changes to GPO configurations, particularly those associated with the attributes `gPCMachineExtensionNames` and `gPCUserExtensionNames`. By focusing on these GPO attributes, the detection identifies when scripts designed to execute at system startup or user logon are added, which might indicate a privilege escalation attempt or persistence mechanism used by an adversary. The associated MITRE ATT&CK techniques include T1484.001 (Group Policy Modification) and T1547 (Boot or Logon Autostart Execution), highlighting the potential risk of abuse in legitimate administrative functions.
  ### Investigation Steps
  - **Verify Event Details:** Review the specific Event IDs (5136 and 5145) in the Windows Security logs to validate the timing and source of the modification to the GPO. Ensure the events are correlated with recent administrative activities.
  - **Examine GPO Configuration:** Utilize the Group Policy Management Console to inspect the GPO in question. Check for any unauthorized or unexpected startup/logon script entries and verify their legitimacy.
  - **Check System Execution Context:** Investigate relevant processes and their execution contexts using EDR tools to determine if the newly added scripts have been executed. Monitor for any unusual behavior linked to user accounts that are typically not associated with GPO modifications.
  - **Assess Access Control List:** Review the Security Access Control Lists (ACLs) for the `\SYSVOL` share and associated scripts. Confirm that permissions are appropriate and suspect any unauthorized 'Write' or 'Change' access that may facilitate harmful modifications.
  ### Prioritization
  Alerts generated by this rule are rated as medium severity due to the implications of unauthorized changes to GPOs, which could signify a significant security risk, including privilege escalation or establishment of persistence mechanisms within the network.
  ### Blind Spots and Assumptions
  This rule may not fire if the advanced audit policy for "Object Access > Audit Detailed File Share" is not correctly configured, leading to a lack of relevant event logging. Additionally, legitimate changes made by system administrators may generate false positives; thus, analysts should consider the context of the modifications. Adversaries could also employ evasion tactics to disguise their activities, potentially preventing detection by this rule. 
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality and relevance, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
