title: ADCS Certificate Template Configuration Vulnerability with Risky EKU
id: bfbd3291-de87-4b7c-88a2-d6a5deb28668
status: test
description: Detects certificate creation with template allowing risk permission subject
  and risky EKU
references:
- https://www.specterops.io/assets/resources/Certified_Pre-Owned.pdf
author: Orlinum , BlueDefenZer
date: 2021-11-17
modified: 2022-12-25
tags:
- attack.privilege-escalation
- attack.credential-access
logsource:
  product: windows
  service: security
  definition: Certificate services loaded a template would trigger event ID 4898 and
    certificate Services template was updated would trigger event ID 4899. A risk
    permission seems to be coming if template contain specific flag with risky EKU.
detection:
  selection10:
    EventID: 4898
    TemplateContent|contains:
    - '1.3.6.1.5.5.7.3.2'
    - '1.3.6.1.5.2.3.4'
    - '1.3.6.1.4.1.311.20.2.2'
    - '2.5.29.37.0'
  selection11:
    TemplateContent|contains: 'CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT'

  selection20:
    EventID: 4899
    NewTemplateContent|contains:
    - '1.3.6.1.5.5.7.3.2'
    - '1.3.6.1.5.2.3.4'
    - '1.3.6.1.4.1.311.20.2.2'
    - '2.5.29.37.0'
  selection21:
    NewTemplateContent|contains: 'CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT'

  condition: (selection10 and selection11) or (selection20 and selection21)
falsepositives:
- Administrator activity
- Proxy SSL certificate with subject modification
- Smart card enrollement
level: high
notes: |
  ### Technical Context
  This Sigma rule is designed to detect potential security risks arising from the misuse of certificate templates in the Active Directory Certificate Services (ADCS). It specifically looks for event IDs 4898 and 4899, which indicate the creation or updating of certificate templates. The rule scrutinizes the template content for specific flag identifiers that denote risky Extended Key Usages (EKU) and allows the enrollment of subjects by users, potentially facilitating unauthorized privilege escalation or credential access. By leveraging Windows security logs, incident responders can identify configurations that pose a risk and investigate further any unsanctioned alterations to certificate authority settings.
  ### Investigation Steps
  - Review the EDR logs for any accounts that triggered Event ID 4898 or 4899, focusing on those with administrative privileges to assess if the activities were legitimate.
  - Utilize SIEM data to correlate these events with user activity logs, checking for anomalies or unusual access patterns around the time of the template creation or modification.
  - Inspect Certificate Services logs to analyze the properties of the created or modified templates, ensuring that no unauthorized flags or EKUs (e.g., `1.3.6.1.5.5.7.3.2`) were introduced.
  - Check related logs in your firewall and web proxy for any outbound connections that may be associated with the use of these certificates, indicating potential misuse or exploitation.
