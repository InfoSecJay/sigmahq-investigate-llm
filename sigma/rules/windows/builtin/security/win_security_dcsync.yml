title: Mimikatz DC Sync
id: 611eab06-a145-4dfa-a295-3ccc5c20f59a
status: test
description: Detects Mimikatz DC sync security events
references:
- https://twitter.com/gentilkiwi/status/1003236624925413376
- https://gist.github.com/gentilkiwi/dcc132457408cf11ad2061340dcb53c2
- https://blog.blacklanternsecurity.com/p/detecting-dcsync?s=r
- https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4662
author: Benjamin Delpy, Florian Roth (Nextron Systems), Scott Dermott, Sorina Ionescu
date: 2018-06-03
modified: 2022-04-26
tags:
- attack.credential-access
- attack.s0002
- attack.t1003.006
logsource:
  product: windows
  service: security
detection:
  selection:
    EventID: 4662
    Properties|contains:
    - 'Replicating Directory Changes All'
    - '1131f6ad-9c07-11d1-f79f-00c04fc2dcd2'
    - '1131f6aa-9c07-11d1-f79f-00c04fc2dcd2'
    - '9923a32a-3607-11d2-b9be-0000f87a36b2'
    - '89e95b76-444d-4c62-991a-0facbeda640c'
    AccessMask: '0x100'
  filter1:
    SubjectDomainName: 'Window Manager'
  filter2:
    SubjectUserName|startswith:
    - 'NT AUT'
    - 'MSOL_'
  filter3:
    SubjectUserName|endswith: '$'
  condition: selection and not 1 of filter*
falsepositives:
- Valid DC Sync that is not covered by the filters; please report
- Local Domain Admin account used for Azure AD Connect
level: high
notes: |
  ### Technical Context
  The Mimikatz DC Sync detection rule aims to identify potential exploitation of the Windows Active Directory (AD) environment by monitoring specific security events associated with unauthorized directory replication attempts. This rule targets Event ID 4662, which logs changes to directory objects and can indicate when an attacker is attempting to replicate the contents of the Active Directory Domain Controller (DC), an action commonly leveraged by the Mimikatz tool to harvest credentials. The rule looks for particular properties within the event record that correlate to compromised replication requests, such as the use of the 'Replicating Directory Changes All' permission.
  The detection conditions are crafted to minimize noise from legitimate activities. It filters out events sourced from recognized accounts, such as local administrators or accounts starting with "MSOL_" which are associated with Azure AD, likely to be benign in nature. By focusing on specific Access Masks and user naming conventions, this rule effectively targets specific attack vectors related to credential theft and Domain Controller compromise as outlined in the MITRE ATT&CK framework under the tactic of Credential Access and the technique T1003.006.
  ### Investigation Steps
  - **Verify Event Sources:** Review the security event logs (Event ID 4662) across relevant Domain Controllers to identify unauthorized replication attempts and corroborate any alerts generated by the rule.
  - **Correlate User Activity:** Utilize EDR tools to analyze the behavior of the user accounts involved, particularly those not typically given directory replication permissions, to assess if suspicious activity has been taking place around the time of the alert.
  - **Review Azure AD Logs:** If applicable, check Azure AD logs for activities connected to accounts with Azure AD Connect to determine any legitimate operations that resemble the patterns detected.
  - **Check for Lateral Movement:** Investigate network connections and process creations to see if there are any lateral movement attempts originating from the alerting user account or its known host, indicating a broader compromise may be in play.
  ### Prioritization
  The alert is classified as high severity since unauthorized DC sync attempts can lead to extensive credential theft and compromise of domain privileges, significantly jeopardizing the security posture of the entire enterprise.
  ### Blind Spots and Assumptions
  This rule may not detect all legitimate DC sync activities, particularly if they originate from accounts not covered by the filtering criteria. Adversaries might bypass detection by using less common accounts or leveraging service accounts that do not follow the expected naming conventions. Additionally, because legitimate automated processes may sometimes trigger these events, there is a risk of false positives if staff are unaware of authorized synchronization activities. Furthermore, if there are misconfigurations in logging settings, some relevant events may not be captured.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environments and operational needs. Please communicate any changes to the detection engineering team.
