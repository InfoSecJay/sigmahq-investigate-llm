title: NetNTLM Downgrade Attack
id: d3abac66-f11c-4ed0-8acb-50cc29c97eed
related:
- id: d67572a0-e2ec-45d6-b8db-c100d14b8ef2
  type: derived
status: test
description: Detects NetNTLM downgrade attack
references:
- https://www.optiv.com/blog/post-exploitation-using-netntlm-downgrade-attacks
author: Florian Roth (Nextron Systems), wagga
date: 2018-03-20
modified: 2022-10-09
tags:
- attack.defense-evasion
- attack.t1562.001
- attack.t1112
# Windows Security Eventlog: Process Creation with Full Command Line
logsource:
  product: windows
  service: security
  definition: 'Requirements: Audit Policy : Object Access > Audit Registry (Success)'
detection:
  selection:
    EventID: 4657
    ObjectName|contains|all:
    - '\REGISTRY\MACHINE\SYSTEM'
    - 'ControlSet'
    - '\Control\Lsa'
    ObjectValueName:
    - 'LmCompatibilityLevel'
    - 'NtlmMinClientSec'
    - 'RestrictSendingNTLMTraffic'
  condition: selection
falsepositives:
- Unknown
level: high
notes: |
  ### Technical Context
  The **NetNTLM Downgrade Attack** detection rule is designed to identify attempts by an attacker to exploit weaknesses in the NTLM authentication protocol. Specifically, the rule focuses on registry modifications related to NTLM security settings, such as `LmCompatibilityLevel`, `NtlmMinClientSec`, and `RestrictSendingNTLMTraffic`. By monitoring these specific registry keys within the Windows operating system, the rule detects changes that may indicate a downgrade attack, where an attacker forces the system to lower its authentication strength, potentially allowing unauthorized access to resources. The relevant Windows Security Event Log used for this detection is the Event ID 4657, which captures changes made to critical system registry keys.
  This rule falls under the MITRE ATT&CK tactics of Defense Evasion and the technique of `T1562.001` (Impair Defenses: Disable or Modify Tools). This technique is particularly significant for SOC analysts as it highlights potential preemptive actions that an adversary may take to weaken security defenses before carrying out further attacks.
  ### Investigation Steps
  - **Check for Registry Modifications**: Utilize Windows Event Logs to review entries linked to Event ID 4657. Pay close attention to modifications made to the `LmCompatibilityLevel`, `NtlmMinClientSec`, and `RestrictSendingNTLMTraffic` registry keys.
  - **Correlate with User Activities**: Investigate user account activities around the time of the event. Use EDR tools to track any suspicious or unauthorized actions taken by accounts associated with the registry changes.
  - **Analyze Network Traffic**: Use NDR tools to identify network traffic related to NTLM authentication attempts. This could provide further context on whether the changes led to any downgrade exploitation in network communications.
  - **Review Historical Settings**: Consult system backups or previous registry states to determine if the detected modifications represent a change from the norm. This can help in assessing the legitimacy of the action and identifying potential compromise.
  ### Prioritization
  Given the high potential for facilitating unauthorized access, alerts generated by this rule are deemed high severity. Such a downgrade could lead to significant security breaches requiring immediate investigation.
  ### Blind Spots and Assumptions
  This rule may not fire in certain scenarios, such as when an attacker modifies registry settings in a manner that remains undetected due to insufficient auditing policies. Additionally, if auditing for relevant registry accesses is not configured, the necessary event logs may not be generated, so it is assumed that proper auditing practices are in place. Furthermore, legitimate administrative changes to these settings may generate false positives unless adequately contextualized by an analyst. Adversaries may also use methods such as direct access or tampering with logs to evade detection.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
