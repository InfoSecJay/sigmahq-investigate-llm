title: Windows Defender Real-Time Protection Failure/Restart
id: dd80db93-6ec2-4f4c-a017-ad40da6ffe81
status: stable
description: Detects issues with Windows Defender Real-Time Protection features
references:
- Internal Research
- https://www.microsoft.com/en-us/security/blog/2023/04/11/guidance-for-investigating-attacks-using-cve-2022-21894-the-blacklotus-campaign/
- https://gist.github.com/nasbench/33732d6705cbdc712fae356f07666346     # Contains the list of Feature Names (use for filtering purposes)
author: Nasreddine Bencherchali (Nextron Systems), Christopher Peacock '@securepeacock'
  (Update)
date: 2023-03-28
modified: 2023-05-05
tags:
- attack.defense-evasion
- attack.t1562.001
logsource:
  product: windows
  service: windefend
detection:
  selection:
    EventID:
    - 3002         # Real-Time Protection feature has encountered an error and failed
    - 3007         # Real-time Protection feature has restarted
  filter_optional_network_inspection:
    Feature_Name: '%%886'     # Network Inspection System
    Reason:
    - '%%892'         # The system is missing updates that are required for running Network Inspection System.  Install the required updates and restart the device.
    - '%%858'         # Antimalware security intelligence has stopped functioning for an unknown reason. In some instances, restarting the service may resolve the problem.
  condition: selection and not 1 of filter_optional_*
falsepositives:
- Some crashes can occur sometimes and the event doesn't provide enough information
  to tune out these cases. Manual exception is required
level: medium
notes: |
  ### Technical Context
  The "Windows Defender Real-Time Protection Failure/Restart" detection rule monitors critical events related to the Windows Defender security suite, particularly its real-time protection capabilities. By tracking the specific Event IDs 3002 and 3007, the rule identifies when the real-time protection feature has either encountered an error or unexpectedly restarted. Additionally, it focuses on filtering events related to the Network Inspection System, specifically when certain known reasons for these failures, such as missing updates or malfunctioning antimalware intelligence, are detected.
  The primary technical data sources involved in this detection are Windows Security logs, which record security events related to process management and system integrity. This logging enables SOC analysts to promptly identify issues that could indicate possible defenses being bypassed or evaded by adversaries. This rule falls under the MITRE ATT&CK framework, specifically aligning with the Defense Evasion tactic (Tactic: defense-evasion, Technique: T1562.001). 
  ### Investigation Steps
  - **Check Windows Security Logs:** Review logs for Event IDs 3002 and 3007 in the Windows Security logs to identify the timeline and frequency of the reported failures or restarts of the real-time protection feature.
  - **Analyze EDR Data:** Utilize your Endpoint Detection and Response (EDR) tool to check for any anomalies or suspicious processes running at the time of these events, which could provide further context for the failures.
  - **Investigate Network Logs:** Examine network-related logs for any unusual connections or activity that may coincide with the reported issues in the Network Inspection System, as this could indicate attempts to bypass security measures.
  - **Review System Update Status:** Verify that the relevant systems have the latest security patches and updates applied, as missing updates could contribute to the failures or restarts of the real-time protection functionality.
  ### Prioritization
  The severity level is considered medium due to the potential implications of such failures. If Windows Defender's real-time protection is disabled or malfunctioning, it could allow malicious activities to go undetected, making it crucial to investigate and remediate any incidents promptly.
  ### Blind Spots and Assumptions
  There are recognized limitations with this rule, including that not all failures will generate an event, leading to potential blind spots in detection. Assumptions include that the rule may not trigger for transient issues or crashes that resolve without requiring further investigation. Additionally, an adversary may exploit Windows Defender's legitimate processes to evade detection, thereby circumventing alerts generated by this rule.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
