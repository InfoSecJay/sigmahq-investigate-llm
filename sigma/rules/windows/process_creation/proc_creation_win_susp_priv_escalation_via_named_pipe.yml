title: Privilege Escalation via Named Pipe Impersonation
id: 9bd04a79-dabe-4f1f-a5ff-92430265c96b
related:
- id: f35c5d71-b489-4e22-a115-f003df287317
  type: derived
status: test
description: Detects a remote file copy attempt to a hidden network share. This may
  indicate lateral movement or data staging activity.
references:
- https://www.elastic.co/guide/en/security/current/privilege-escalation-via-named-pipe-impersonation.html
author: Tim Rauch, Elastic (idea)
date: 2022-09-27
modified: 2022-12-30
tags:
- attack.lateral-movement
- attack.t1021
logsource:
  category: process_creation
  product: windows
detection:
  selection_name:
  - Image|endswith:
    - '\cmd.exe'
    - '\powershell.exe'
  - OriginalFileName:
    - 'Cmd.Exe'
    - 'PowerShell.EXE'
  selection_args:
    CommandLine|contains|all:
    - 'echo'
    - '>'
    - '\\\\.\\pipe\\'
  condition: all of selection*
falsepositives:
- Other programs that cause these patterns (please report)
level: high
notes: |
  n
  ### Technical Context
  The "Privilege Escalation via Named Pipe Impersonation" Sigma rule is designed to identify potentially malicious activity related to lateral movement or data staging within an enterprise environment. The rule focuses on process creation events, specifically monitoring the command-line activities of `cmd.exe` and `powershell.exe`. It detects instances where these commands contain the use of named pipes, specifically when the command line includes elements indicative of redirecting output to a named pipe (e.g., the use of `echo` and `> \\\\.\\pipe\\`). This can signify attempts to interact with hidden network shares for unauthorized purposes. The relevant MITRE ATT&CK techniques that this rule addresses include T1021 (Remote Services) associated with lateral movement tactics. 
  The telemetry monitoring for this rule is primarily sourced from Windows Sysmon logs, specifically focusing on process creation events which provide essential details, such as command-line parameters, that indicate potentially nefarious activities. By detecting such command patterns, the organization can proactively respond to suspicious behavior that might lead to unauthorized privilege escalation or data exfiltration.
  ### Investigation Steps
  - **Check EDR Alerts**: Review EDR alerts related to the timestamp mentioned in the alert to identify suspicious activities or malware processes running concurrently with the named pipe executions.
  - **Examine Process Creation Logs**: Search through Windows Sysmon logs for specific process creation events involving `cmd.exe` or `powershell.exe`, and carefully analyze the command-line arguments for suspicious patterns.
  - **Analyze Network Connections**: Use network detection tools to inspect outbound connections around the time of the alert to identify any unusual communications that could correlate with named pipe activities.
  - **Inspect Antivirus Logs**: Alert on any related antivirus logs to see if any signatures were triggered by potentially malicious commands or the usage of the named pipe intended to exploit system privileges.
  ### Prioritization
  Given the potential impact of privilege escalation and lateral movement, alerts generated by this rule should be treated with high severity. Compromised accounts or unauthorized access could lead to significant breaches and data loss.
  ### Blind Spots and Assumptions
  This rule may not trigger if the named pipe usage is obfuscated or if attackers use stealthier methods to execute commands without logging them properly. Additionally, legitimate applications or maintenance scripts might inadvertently generate similar command patterns, resulting in false positives. It's essential to continuously refine detection parameters and log sources to ensure adversary techniques evolve in line with the security posture.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
