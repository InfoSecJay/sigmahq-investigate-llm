title: VMToolsd Suspicious Child Process
id: 5687f942-867b-4578-ade7-1e341c46e99a
status: test
description: Detects suspicious child process creations of VMware Tools process which
  may indicate persistence setup
references:
- https://bohops.com/2021/10/08/analyzing-and-detecting-a-vmtools-persistence-technique/
- https://user-images.githubusercontent.com/61026070/136518004-b68cce7d-f9b8-4e9a-9b7b-53b1568a9a94.png
- https://github.com/vmware/open-vm-tools/blob/master/open-vm-tools/tools.conf
author: bohops, Bhabesh Raj
date: 2021-10-08
modified: 2023-07-25
tags:
- attack.execution
- attack.persistence
- attack.t1059
logsource:
  category: process_creation
  product: windows
detection:
  selection_parent:
    ParentImage|endswith: '\vmtoolsd.exe'
  selection_img:
  - Image|endswith:
    - '\cmd.exe'
    - '\cscript.exe'
    - '\mshta.exe'
    - '\powershell.exe'
    - '\pwsh.exe'
    - '\regsvr32.exe'
    - '\rundll32.exe'
    - '\wscript.exe'
  - OriginalFileName:
    - 'Cmd.Exe'
    - 'cscript.exe'
    - 'MSHTA.EXE'
    - 'PowerShell.EXE'
    - 'pwsh.dll'
    - 'REGSVR32.EXE'
    - 'RUNDLL32.EXE'
    - 'wscript.exe'
  filter_main_vmwaretools_script:
    Image|endswith: '\cmd.exe'
    CommandLine|contains:
    - '\VMware\VMware Tools\poweron-vm-default.bat'
    - '\VMware\VMware Tools\poweroff-vm-default.bat'
    - '\VMware\VMware Tools\resume-vm-default.bat'
    - '\VMware\VMware Tools\suspend-vm-default.bat'
  filter_main_empty:
    Image|endswith: '\cmd.exe'
    CommandLine: ''
  filter_main_null:
    Image|endswith: '\cmd.exe'
    CommandLine:
  condition: all of selection* and not 1 of filter_main_*
falsepositives:
- Legitimate use by VM administrator
level: high
notes: |
  n
  ### Technical Context
  The "VMToolsd Suspicious Child Process" detection rule is designed to identify potentially malicious child processes spawned by the VMware Tools daemon (`vmtoolsd.exe`). This rule specifically looks for the creation of processes like `cmd.exe`, `powershell.exe`, and several others that may indicate advanced persistence mechanisms abused by malicious actors within a virtualized environment. By monitoring process creation logs, particularly focusing on command-line parameters related to VMware Tools scripts, the rule helps to distinguish between legitimate administrative actions and possible exploitation attempts. 
  When an adversary compromises a system running in a virtualized environment, they might use `vmtoolsd.exe` as a parent process to execute further commands or scripts with escalated privileges. This behavior may exemplify techniques under the MITRE ATT&CK tactics of execution (T1059) and persistence (T1098). The logs from Windows process creation events play a key role in enabling this detection.
  ### Investigation Steps
  - **Check EDR Logs:** Review EDR for any alerts related to `vmtoolsd.exe` and the identified child processes to assess the context of their execution.
  - **Analyze Command-Line Arguments:** Analyze the command-line parameters associated with the detected child processes, particularly for any unusual or unexpected script invocations from VMware Tools.
  - **Correlate with User Activity:** Cross-reference the process creation events with user activity logs to determine whether the commands were issued by authorized users or system processes.
  - **Review VM Configurations:** Examine the VM settings and configurations to identify whether any legitimate administrative actions correlate with the suspicious process creation events.
  ### Prioritization
  The alert generated by this rule is classified as high severity due to the potential for an adversary to establish persistence mechanisms in a compromised virtual machine environment, which could lead to significant security risks.
  ### Blind Spots and Assumptions
  This rule may not fire in environments where VMware Tools is not used or if process creation is logged incompletely due to insufficient logging configurations. Additionally, legitimate VM Administrators may occasionally invoke these commands, leading to potential false positives. It's vital for the SOC team to tune the alerting thresholds based on historical baselines and to validate the alerts against typical administrative behavior to mitigate noise.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
