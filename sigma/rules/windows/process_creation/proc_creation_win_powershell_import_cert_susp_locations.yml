title: Root Certificate Installed From Susp Locations
id: 5f6a601c-2ecb-498b-9c33-660362323afa
status: test
description: Adversaries may install a root certificate on a compromised system to
  avoid warnings when connecting to adversary controlled web servers.
references:
- https://www.microsoft.com/security/blog/2022/09/07/profiling-dev-0270-phosphorus-ransomware-operations/
- https://learn.microsoft.com/en-us/powershell/module/pki/import-certificate?view=windowsserver2022-ps
author: Nasreddine Bencherchali (Nextron Systems)
date: 2022-09-09
modified: 2023-01-16
tags:
- attack.defense-evasion
- attack.t1553.004
logsource:
  category: process_creation
  product: windows
detection:
  selection:
    CommandLine|contains|all:
    - 'Import-Certificate'
    - ' -FilePath '
    - 'Cert:\LocalMachine\Root'
    CommandLine|contains:
    - '\AppData\Local\Temp\'
    - ':\Windows\TEMP\'
    - '\Desktop\'
    - '\Downloads\'
    - '\Perflogs\'
    - ':\Users\Public\'
  condition: selection
falsepositives:
- Unlikely
level: high
notes: |
  n
  ### Technical Context
  This Sigma rule detects the installation of root certificates from suspicious locations on Windows systems, which can indicate malicious behavior by adversaries attempting to evade detection while connecting to their controlled web servers. Specifically, the rule looks for instances where the `Import-Certificate` PowerShell command is executed with a file path pointing to common user directories such as `Temp`, `Desktop`, `Downloads`, and `Public`. The key data sources involved in this detection include Windows process creation logs, which capture command-line parameters used in processes, and leverage Sysmon telemetry to expose potentially malicious activities. This aligns with the MITRE ATT&CK technique T1553.004, which highlights the risk of root certificate installation as a method for bypassing security measures.
  ### Investigation Steps
  - **Review Process Creation Logs:** Check the process creation logs for instances of the `Import-Certificate` command to identify which user executed it and confirm if the associated file paths are indeed suspicious.
  - **Analyze PowerShell Logs:** Investigate PowerShell logs to gather additional context on the execution, including any previous commands run in the same session that may reveal intent or links to other malicious activities.
  - **Inspect Certificate Store:** Use tools such as Certutil or PowerShell to examine the root certificate store (`Cert:\LocalMachine\Root`) for any unauthorized certificates that may have been installed during the detected activity.
  - **Correlate with Network Logs:** Cross-reference network connection logs and proxy logs to check for connections made to known adversary-controlled domains that may correspond with the timing of the certificate import.
  ### Prioritization
  Alerts generated by this rule should be treated with high severity due to the potential for significant security risks associated with the unauthorized installation of root certificates, which can compromise secure communications and facilitate further attacks.
  ### Blind spots and Assumptions
  This rule may not fire if the installation of root certificates occurs through other legitimate means or when the command execution is obfuscated or modified to avoid detection. Additionally, if adversaries clean up logs or utilize system utilities that do not generate process creation logs, the detection may be defeated. Assumptions include a reliance on standard user pathways for suspicious file locations; if adversaries store certificates in less common directories or if environments have different behaviors, additional tuning may be necessary.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
