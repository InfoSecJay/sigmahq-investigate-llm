title: New Generic Credentials Added Via Cmdkey.EXE
id: b1ec66c6-f4d1-4b5c-96dd-af28ccae7727
status: test
description: |
  Detects usage of "cmdkey.exe" to add generic credentials.
  As an example, this can be used before connecting to an RDP session via command line interface.
references:
- https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1021.001/T1021.001.md#t1021001---remote-desktop-protocol
author: frack113, Nasreddine Bencherchali (Nextron Systems)
date: 2023-02-03
modified: 2024-03-05
tags:
- attack.credential-access
- attack.t1003.005
logsource:
  category: process_creation
  product: windows
detection:
  selection_img:
  - Image|endswith: '\cmdkey.exe'
  - OriginalFileName: 'cmdkey.exe'
  selection_cli_generic:
    CommandLine|contains|windash: ' -g'     # Generic
  selection_cli_user:
    CommandLine|contains|windash: ' -u'     # User
  selection_cli_password:
    CommandLine|contains|windash: ' -p'     # Password
  condition: all of selection_*
falsepositives:
- Legitimate usage for administration purposes
level: medium
notes: |
  n
  ### Technical Context
  This detection rule is designed to identify the usage of "cmdkey.exe," a Windows command-line utility that allows users to create, display, and remove stored user credentials. The rule specifically looks for instances where cmdkey is being executed with command-line parameters indicating the addition of generic credentials, as evidenced by flags such as `-g`, `-u`, and `-p`. By watching for process creation events involving cmdkey.exe and analyzing the associated command-line parameters, this rule can help detect potentially malicious activities, particularly those associated with unauthorized access to Remote Desktop Protocol (RDP) sessions. This activity falls under the MITRE ATT&CK tactic of Credential Access, specifically technique T1003.005.
  The primary data sources involved in this rule are process creation logs, which capture details about command execution, including the image name and command-line arguments. This means that an effective investigation into the alerts generated by this rule will rely on scrutinizing process creation events, examining both the nature of the command executed and its parameters.
  ### Investigation Steps
  - **Review Process Creation Logs:** Check the process creation logs for occurrences of cmdkey.exe. Specifically, look for logs that show the execution of cmdkey with the flags for generic credentials addition.
    
  - **Analyze Command-Line Parameters:** Examine the command-line arguments used with cmdkey.exe to verify the inclusion of `-g`, `-u`, and `-p` flags. This will help determine the intent of the command and whether it aligns with normal administrative activities.
    
  - **Correlate with User Activity:** Utilize EDR tools to correlate the cmdkey execution with the user account's activities at that time. Pay attention to any other suspicious activities that could indicate a breach or unauthorized access.
  - **Check Network Connections:** Use network security tools to see if the machine that executed cmdkey.exe made any network connections to external RDP services post-execution. Identify any unusual or unauthorized access attempts.
  ### Prioritization
  This alert carries a medium severity level due to the potential misuse of credential management tools, which can facilitate unauthorized access to sensitive systems such as those using RDP. Timely response is crucial, as this activity could be a precursor to further malicious actions.
  ### Blind Spots and Assumptions
  It is essential to consider that legitimate administrative activities may result in false positives when using cmdkey.exe. Additionally, if an adversary accesses the system with elevated permissions or uses alternative methods (e.g., PowerShell with similar capabilities), this rule may not fire. Other detection engineers should understand that robust monitoring against alternative credential access methods is necessary to ensure comprehensive coverage.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
