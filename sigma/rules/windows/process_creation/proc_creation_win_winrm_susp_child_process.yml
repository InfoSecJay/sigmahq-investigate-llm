title: Suspicious Processes Spawned by WinRM
id: 5cc2cda8-f261-4d88-a2de-e9e193c86716
status: test
description: Detects suspicious processes including shells spawnd from WinRM host
  process
author: Andreas Hunkeler (@Karneades), Markus Neis
references:
- Internal Research
date: 2021-05-20
modified: 2022-07-14
tags:
- attack.t1190
- attack.initial-access
- attack.persistence
- attack.privilege-escalation
logsource:
  category: process_creation
  product: windows
detection:
  selection:
    ParentImage|endswith: '\wsmprovhost.exe'
    Image|endswith:
    - '\cmd.exe'
    - '\sh.exe'
    - '\bash.exe'
    - '\powershell.exe'
    - '\pwsh.exe'
    - '\wsl.exe'
    - '\schtasks.exe'
    - '\certutil.exe'
    - '\whoami.exe'
    - '\bitsadmin.exe'
  condition: selection
falsepositives:
- Legitimate WinRM usage
level: high
notes: |
  n
  ### Technical Context
  This Sigma rule is designed to detect suspicious process creations that are spawned from the WinRM (Windows Remote Management) host process, `wsmprovhost.exe`. The rule specifically monitors the creation of processes that end with specific filenames commonly associated with command-line interfaces or administrative tools, including shells (`cmd.exe`, `sh.exe`, `bash.exe`, `powershell.exe`, etc.) and potentially malicious tools such as `certutil.exe` and `bitsadmin.exe`. By capturing parent-child process relationships, this rule identifies cases where these commonly used tools are invoked in a context that suggests misuse, potentially indicating an attempt at initial access, privilege escalation, or persistence within the environment. The rule implements log data sourced from Windows process creation events, which includes critical information such as command-line parameters and parent processes, facilitating the identification of anomalous behaviors. The tactics and techniques referenced in the MITRE ATT&CK framework include T1190 (Exploit Public-Facing Application) and various techniques related to initial access, persistence, and privilege escalation.
  ### Investigation Steps
  - **Check Process Creation Logs:** Review Windows process creation logs from your EDR for instances of processes initiated by `wsmprovhost.exe`, noting any suspicious command-line arguments or execution contexts.
    
  - **Verify User Context:** Identify the user context under which the suspicious process was created, checking for any unauthorized or unusual accounts that may point to potential exploitation.
  - **Cross-Referencing with Security Events:** Correlate alerts with Windows Security, System, or Application logs to determine if there were preceding authentication events associated with remote access attempts or unauthorized changes.
  - **Examine Network Connections:** Utilize NDR and firewall logs to analyze any outbound or unusual network connections established by the suspicious processes, revealing potential data exfiltration or further compromise.
  ### Prioritization
  Alerts generated by this rule are prioritized as high severity due to the inherent risks associated with process manipulation via WinRM, which could indicate an ongoing attack or significant compromise.
  ### Blind spots and Assumptions
  There are inherent limitations when monitoring for suspicious processes derived from legitimate WinRM usage, which can lead to false positives under normal operational circumstances. Additionally, this rule may not fire if the attack vector bypasses the `wsmprovhost.exe` parent process (such as using alternative methods for process creation). Adversaries could also employ techniques to obfuscate command-line arguments, further evading detection.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
