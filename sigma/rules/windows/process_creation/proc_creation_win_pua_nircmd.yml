title: PUA - NirCmd Execution
id: 4e2ed651-1906-4a59-a78a-18220fca1b22
status: test
description: Detects the use of NirCmd tool for command execution, which could be
  the result of legitimate administrative activity
references:
- https://www.nirsoft.net/utils/nircmd.html
- https://www.winhelponline.com/blog/run-program-as-system-localsystem-account-windows/
- https://www.nirsoft.net/utils/nircmd2.html#using
author: Florian Roth (Nextron Systems), Nasreddine Bencherchali (Nextron Systems)
date: 2022-01-24
modified: 2023-02-13
tags:
- attack.execution
- attack.t1569.002
- attack.s0029
logsource:
  category: process_creation
  product: windows
detection:
  selection_org:
  - Image|endswith: '\NirCmd.exe'
  - OriginalFileName: 'NirCmd.exe'
  selection_cmd:
    CommandLine|contains:
    - ' execmd '
    - '.exe script '
    - '.exe shexec '
    - ' runinteractive '
  combo_exec:
    CommandLine|contains:
    - ' exec '
    - ' exec2 '
  combo_exec_params:
    CommandLine|contains:
    - ' show '
    - ' hide '
  condition: 1 of selection_* or all of combo_*
fields:
- CommandLine
- ParentCommandLine
falsepositives:
- Legitimate use by administrators
level: medium
notes: |
  ### Technical Context
  The Sigma rule titled "PUA 
  - NirCmd Execution" is designed to identify instances where the NirCmd command-line utility is executed on a Windows system. NirCmd is a versatile tool often used for legitimate administrative purposes, such as system configurations and automation tasks. However, its capability to execute commands, scripts, and even interact with system processes makes it a potential vector for misuse by attackers to perform malicious activities under the guise of legitimate operations. 
  This rule monitors process creation logs to detect when NirCmd is launched (specifically looking for the image name "NirCmd.exe" and its original file name), as well as specific command-line parameters that indicate potentially harmful execution patterns, such as calls to `execmd`, running scripts, or commands that direct it to show or hide elements. The technical data sources involved include process creation events which provide detailed information about launched processes, including command-line arguments and parent processes. The rule aligns with the MITRE ATT&CK technique "Command-Line Interface" (T1059) as it highlights potential adversarial use of command-line tools to execute code.
  ### Investigation Steps
  - **Check Process Creation Logs:** Investigate recent process creation logs in your EDR solution for instances of `NirCmd.exe`, paying close attention to the command-line parameters used during execution.
  - **Analyze Parent Processes:** Examine the parent processes of NirCmd executions to determine whether they originated from legitimate administrative tools or suspicious applications.
  - **Correlate with Other Logs:** Cross-reference your findings with Windows Event Logs (Security, System) and Sysmon logs to identify any related activities that might indicate a broader security incident.
  - **Evaluate User Context:** Review user account activity to ascertain whether the command was executed by an administrator or a potentially compromised account to assess the legitimacy of the action.
  ### Prioritization
  Alerts generated by this rule are evaluated at a medium severity level due to the nature of the NirCmd utility, which could be utilized for both legitimate administrative functions as well as malicious activities. If an alert is triggered, further investigation is warranted to determine the context and intent behind the execution.
  ### Blind Spots and Assumptions
  This rule may not fire if:
  - NirCmd is executed with obfuscated command-line arguments that do not match the specified patterns in the rule.
  - The execution occurs in a manner that bypasses process creation logging, such as through malicious use of scripting languages that do not generate traditional process creation events.
  - There may be legitimate administrative use cases for NirCmd that could lead to false positives. Analysts should consider the operational context when reviewing alerts.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality and appropriateness, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
