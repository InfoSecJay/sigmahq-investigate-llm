title: Conhost.exe CommandLine Path Traversal
id: ee5e119b-1f75-4b34-add8-3be976961e39
status: test
description: detects the usage of path traversal in conhost.exe indicating possible
  command/argument confusion/hijacking
references:
- https://pentestlab.blog/2020/07/06/indirect-command-execution/
author: Nasreddine Bencherchali (Nextron Systems)
date: 2022-06-14
tags:
- attack.execution
- attack.t1059.003
logsource:
  category: process_creation
  product: windows
detection:
  selection:
    ParentCommandLine|contains: 'conhost'
    CommandLine|contains: '/../../'
  condition: selection
falsepositives:
- Unlikely
level: high
notes: |
  ### Technical Context
  The "Conhost.exe CommandLine Path Traversal" detection rule is designed to identify potential command and argument confusion or hijacking through the `conhost.exe` process on Windows systems. This rule specifically looks for instances where the command line invoked by `conhost.exe` contains path traversal patterns, specifically `'/../../'`. This can indicate an attempt by an attacker to exploit the behavior of the Windows console host, potentially leading to unauthorized access to files or system resources.
  The primary data sources leveraged by this rule include Windows process creation logs, as well as the command line used during the process invocation. The rule also aligns with the MITRE ATT&CK tactics, specifically aiming at the Execution tactic (Attack Technique T1059.003), which encompasses script-based execution and other indirect command execution methods that can facilitate adversarial activities.
  ### Investigation Steps
  - **Review Process Creation Logs:** Examine the Windows process creation logs to identify instances of `conhost.exe` being invoked. Pay attention to parent process relationships to ascertain the context of execution.
  - **Analyze Command Line Arguments:** Investigate the specific command line arguments used in the instance of `conhost.exe`. Look for suspicious path traversal patterns beyond the initial trigger to assess potential malicious intent.
  - **Correlate with Sysmon Logs:** Utilize Sysmon logs, specifically for process creations and command line arguments, to gain deeper insights into the activity surrounding `conhost.exe`. This can help discern whether the execution was legitimate or if it indicates an underlying compromise.
  - **Check for Related Network Activity:** If applicable, analyze network connections established by the process to identify any communications with potential malicious servers, thus understanding the broader implications of the detected activity.
  ### Prioritization
  The alert generated by this rule is marked as high severity due to the potential risk of command execution confusion or hijacking through a legitimate system process. The detection of such activity warrants immediate investigation, as it may lead to further exploitation and compromise of sensitive data.
  ### Blind Spots and Assumptions
  This rule may not fire if the attack does not involve `conhost.exe` or if the attacker employs obfuscation techniques that evade traditional command line detection patterns. Furthermore, there is an assumption that the monitoring of process creation logs is configured correctly within the enterprise environment. If `conhost.exe` is invoked by processes without a clear visible parent relationship, the rule may also fail to execute correctly. Adversaries may implement tactics to disguise the misuse of legitimate processes, thus evading detection.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
