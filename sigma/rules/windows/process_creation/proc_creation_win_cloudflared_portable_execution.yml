title: Cloudflared Portable Execution
id: fadb84f0-4e84-4f6d-a1ce-9ef2bffb6ccd
status: test
description: |
  Detects the execution of the "cloudflared" binary from a non standard location.
references:
- https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/do-more-with-tunnels/trycloudflare/
- https://github.com/cloudflare/cloudflared
- https://www.intrinsec.com/akira_ransomware/
- https://www.guidepointsecurity.com/blog/tunnel-vision-cloudflared-abused-in-the-wild/
- https://github.com/cloudflare/cloudflared/releases
author: Nasreddine Bencherchali (Nextron Systems)
tags:
- attack.command-and-control
- attack.t1090.001
date: 2023-12-20
logsource:
  category: process_creation
  product: windows
detection:
  selection:
    Image|endswith: '\cloudflared.exe'
  filter_main_admin_location:
    Image|contains:
    - ':\Program Files (x86)\cloudflared\'
    - ':\Program Files\cloudflared\'
  condition: selection and not 1 of filter_main_*
falsepositives:
- Legitimate usage of Cloudflared portable versions
level: medium
notes: |
  ### Technical Context
  The "Cloudflared Portable Execution" detection rule aims to identify instances where the `cloudflared` executable is launched from non-standard locations on a Windows system. Cloudflared is a tool used to create secure tunnels for securing applications behind Cloudflare's services. However, adversaries may misuse this legitimate software for command-and-control purposes, particularly if it is executed from arbitrary or atypical directories, potentially indicating malicious intent. This detection leverages Windows process creation logs, specifically monitoring for instances of `cloudflared.exe` while filtering out executions from known legitimate installation directories, such as `C:\Program Files (x86)\cloudflared\` and `C:\Program Files\cloudflared\`. The detection aligns with the MITRE ATT&CK framework, particularly under the tactic of Command and Control (T1090.001).
  ### Investigation Steps
  - **Verify the Context of Execution:** Check when and how `cloudflared.exe` was executed by reviewing the Windows Event Logs, particularly the Security logs for process creation events and correlating with user activity at that time.
  - **Analyze Running Processes:** Utilize EDR tools to examine currently running processes and their parent processes, focusing on the execution path to confirm whether it aligns with legitimate use cases.
  - **Network Traffic Review:** Inspect network connections established by the suspicious `cloudflared.exe` process using the Network Detection and Response (NDR) system to identify any unusual outbound connections that could indicate data exfiltration or interaction with known malicious IPs.
  - **Check for Previous Alerts:** Search for prior alerts or incidents related to `cloudflared` to ascertain any historical context that may shed light on the execution's legitimacy or previous incidents involving the same executable.
  ### Prioritization
  The alert generated by this rule is deemed medium severity due to the potential misuse of `cloudflared` for command-and-control activities. While it could indicate legitimate usage, the execution from atypical locations warrants prompt investigation to rule out any malicious intent.
  ### Blind Spots and Assumptions
  This detection rule operates under the assumption that `cloudflared.exe` will not be executed from standard installation directories, yet legitimate users may use portable versions from non-standard locations. Additionally, if adversaries have employed tactics to mask their activity (e.g., renaming the executable or altering the path to blend with legitimate applications), the rule may fail to trigger. Lastly, environments lacking comprehensive process creation logging may also miss detection.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
