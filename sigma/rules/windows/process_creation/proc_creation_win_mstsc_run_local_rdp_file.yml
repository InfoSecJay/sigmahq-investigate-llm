title: Mstsc.EXE Execution With Local RDP File
id: 5fdce3ac-e7f9-4ecd-a3aa-a4d78ebbf0af
status: test
description: Detects potential RDP connection via Mstsc using a local ".rdp" file
references:
- https://www.blackhillsinfosec.com/rogue-rdp-revisiting-initial-access-methods/
- https://web.archive.org/web/20230726144748/https://blog.thickmints.dev/mintsights/detecting-rogue-rdp/
author: Nasreddine Bencherchali (Nextron Systems), Christopher Peacock @securepeacock
date: 2023-04-18
modified: 2023-04-30
tags:
- attack.command-and-control
- attack.t1219
logsource:
  category: process_creation
  product: windows
detection:
  selection_img:
  - Image|endswith: '\mstsc.exe'
  - OriginalFileName: 'mstsc.exe'
  selection_cli:
    CommandLine|endswith:
    - '.rdp'
    - '.rdp"'
  filter_optional_wsl:
    ParentImage: 'C:\Windows\System32\lxss\wslhost.exe'
    CommandLine|contains: 'C:\ProgramData\Microsoft\WSL\wslg.rdp'
  condition: all of selection_* and not 1 of filter_optional_*
falsepositives:
- Likely with legitimate usage of ".rdp" files
level: low
notes: |
  ### Technical Context
  The Sigma rule titled "Mstsc.EXE Execution With Local RDP File" is designed to detect the execution of Microsoft's Remote Desktop Connection (mstsc.exe) with a local Remote Desktop Protocol (RDP) file. This rule specifically monitors the process creation logs on Windows systems, focusing on instances where `mstsc.exe` is executed with a command-line parameter that ends with an ".rdp" file. The rule also includes an exception filter to minimize false positives generated by valid usage, such as connections initiated via Windows Subsystem for Linux or other legitimate scenarios.
  When the rule triggers, it indicates a potential command-and-control tactic as outlined in the MITRE ATT&CK framework, particularly technique T1219, which pertains to Remote Access Software. This is a relevant concern because malicious actors may leverage RDP connections to gain unauthorized remote access to systems within an enterprise, making it crucial for responders to investigate the context and origins of these connection attempts.
  ### Investigation Steps
  - **Review Process Creation Logs**: Use your EDR to examine the process creation logs and confirm the full command line used with mstsc.exe along with its parent process for context.
  - **Examine Network Connections**: Check relevant EDR logs for any outbound network connections made by the detected instance of mstsc.exe, identifying the destination IP addresses and ports accessed.
  - **Analyze the .rdp File**: Investigate the contents of the RDP file used in the connection to ensure it does not point to known malicious IPs or servers and to verify the validity of the connection parameters.
  - **Cross-Reference User Activity**: Correlate the execution event with user activity logs to ascertain whether the user is authorized to initiate RDP connections and if the timing of the event aligns with normal business operations.
  ### Prioritization
  The alert has been categorized as low severity; however, it warrants attention because while the execution of mstsc.exe with RDP files can occur legitimately, it can also indicate attempts at unauthorized access, underscoring the importance of contextual investigation.
  ### Blind spots and Assumptions
  This rule may not fire in scenarios where the `mstsc.exe` process is executed without the associated command-line parameter indicating an RDP file, or when attackers obfuscate their actions. Additionally, there may be legitimate use cases that result in false positives, particularly from trusted users utilizing smart practices in RDP access. Adversaries might employ alternative methods of access or processes not captured by this rule, such as using alternate remote connection tools that do not invoke `mstsc.exe`. Engineers are encouraged to consider the environment and user behavior when implementing this detection.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
