title: Potential MsiExec Masquerading
id: e22a6eb2-f8a5-44b5-8b44-a2dbd47b1144
status: test
description: Detects the execution of msiexec.exe from an uncommon directory
references:
- https://twitter.com/200_okay_/status/1194765831911215104
author: Florian Roth (Nextron Systems)
date: 2019-11-14
modified: 2023-02-21
tags:
- attack.defense-evasion
- attack.t1036.005
logsource:
  category: process_creation
  product: windows
detection:
  selection:
  - Image|endswith: '\msiexec.exe'
  - OriginalFileName: '\msiexec.exe'
  filter:
    Image|startswith:
    - 'C:\Windows\System32\'
    - 'C:\Windows\SysWOW64\'
    - 'C:\Windows\WinSxS\'
  condition: selection and not filter
falsepositives:
- Unknown
level: high
notes: |
  ### Technical Context
  The "Potential MsiExec Masquerading" detection rule is designed to identify potentially malicious use of the `msiexec.exe` executable when it is executed from an uncommon directory. Normally, `msiexec.exe` is located in known system directories (`C:\Windows\System32\`, `C:\Windows\SysWOW64\`, and `C:\Windows\WinSxS\`). This rule leverages process creation logs to flag instances where `msiexec.exe` is invoked from paths that deviate from these standard locations, indicating possible attempts at evading detection by masquerading as a legitimate utility. This behavior aligns with the MITRE ATT&CK tactic of Defense Evasion (T1070.005) by using legitimate tools for potentially illicit activities.
  The technical analysis focuses on the file path of the executable and its original filename to ensure that the process in question is indeed `msiexec.exe`. The unique detection logic employed helps to filter out benign instances of `msiexec.exe` while highlighting suspicious executions that could indicate an adversary's intent to manipulate system resources.
  ### Investigation Steps
  - **Check Process Creation Logs:** Search EDR or Sysmon logs for events related to `msiexec.exe` executions and examine their Source Path and Original File Name for anomalies.
    
  - **Analyze Command-Line Arguments:** Review command-line parameters passed during the execution of `msiexec.exe` from the logs to identify anything unusual or indicative of malicious intent.
    
  - **Review Related Processes:** Investigate parent and child process relationships in the execution chain. The presence of other suspicious processes may signal malicious activity or coordination.
  - **Correlate with User Activity:** Cross-reference the execution times with user activity logs to determine if the execution was authorized or potentially tied to user account abuse.
  ### Prioritization
  The alert generated by this rule is classified as high severity due to the potential risks associated with the misuse of a legitimate system installer. Unauthorized execution from unusual directories can signal attempts by adversaries to run malicious software disguised as trusted applications, warranting prompt investigation.
  ### Blind Spots and Assumptions
  This rule may not capture scenarios where `msiexec.exe` is executed from a legitimate directory due to pre-existing configurations or where adversaries successfully implement obfuscation techniques. Additionally, environments with external applications that might intentionally deploy software using `msiexec.exe` from uncommon paths may generate false positives. It is also assumed that the monitoring of process creation logs is comprehensive, which may not always be the case in environments with rigorous filtering or limited logging capabilities.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
