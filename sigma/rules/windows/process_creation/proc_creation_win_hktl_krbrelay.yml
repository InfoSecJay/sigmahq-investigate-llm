title: HackTool - KrbRelay Execution
id: e96253b8-6b3b-4f90-9e59-3b24b99cf9b4
status: test
description: Detects the use of KrbRelay, a Kerberos relaying tool
references:
- https://github.com/cube0x0/KrbRelay
author: Florian Roth (Nextron Systems)
date: 2022-04-27
modified: 2023-02-04
tags:
- attack.credential-access
- attack.t1558.003
logsource:
  category: process_creation
  product: windows
detection:
  selection_img:
  - Image|endswith: '\KrbRelay.exe'
  - OriginalFileName: 'KrbRelay.exe'       # In case the file has been renamed after compilation
  selection_cli_1:
    CommandLine|contains|all:
    - ' -spn '
    - ' -clsid '
    - ' -rbcd '
  selection_cli_2:
    CommandLine|contains|all:
    - 'shadowcred'
    - 'clsid'
    - 'spn'
  selection_cli_3:
    CommandLine|contains|all:
    - 'spn '
    - 'session '
    - 'clsid '
  condition: 1 of selection_*
falsepositives:
- Unlikely
level: high
notes: |
  ### Technical Context
  The Sigma rule titled "HackTool 
  - KrbRelay Execution" is designed to detect the execution of KrbRelay, a tool used for Kerberos relaying attacks that can compromise user credentials and access within a network. The rule identifies the execution of the KrbRelay.exe process by examining process creation logs for specific characteristics such as the image name and original file name associated with the executable. Additionally, it analyzes command-line parameters passed during the execution to pinpoint the use of keywords associated with Kerberos ticket manipulation, including `-spn`, `-clsid`, and `-rbcd`. 
  By leveraging process creation logs as the primary data source, this rule allows SOC analysts to monitor for abnormal or unauthorized use of the KrbRelay tool that could indicate credential theft or other malicious activities. This detection directly aligns with the MITRE ATT&CK tactic of Credential Access and the specific technique T1558.003 related to credential dumping.
  ### Investigation Steps
  - **Check Process Activity:** Examine the process creation logs in the EDR for instances of KrbRelay.exe and review the associated user account that initiated the process.
  - **Analyze Command-Line Arguments:** Look for specific command-line parameters passed to the KrbRelay process to determine the intent of the execution and whether it aligns with the organization's normal operational use.
  - **Review Network Connections:** Utilize NDR tools to investigate outbound network connections made by the process, identifying any communications with suspicious or external IP addresses.
  - **Correlate Logs from Other Sources:** Cross-reference logs from Windows Security Event logs, AV, and Proxy logs to identify any additional malicious activity or patterns that may correlate with the detection of KrbRelay execution.
  ### Prioritization
  The alert generated by this rule is considered high severity due to the potential for significant credential compromise and subsequent unauthorized access, risks that can lead to further exploitation of the enterprise environment.
  ### Blind Spots and Assumptions
  This detection rule may not fire in instances where the KrbRelay tool is executed from hidden or non-standard paths or if the executable has been renamed. Additionally, if the attack modifies command-line parameters or utilizes alternative methods not captured by this rule, detection may be bypassed. It is also assumed that the necessary logging levels are enabled in the environment, which might not always be the case.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
