title: File Decoded From Base64/Hex Via Certutil.EXE
id: cc9cbe82-7bc0-4ef5-bc23-bbfb83947be7
status: test
description: Detects the execution of certutil with either the "decode" or "decodehex"
  flags to decode base64 or hex encoded files. This can be abused by attackers to
  decode an encoded payload before execution
references:
- https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/certutil
- https://unit42.paloaltonetworks.com/new-babyshark-malware-targets-u-s-national-security-think-tanks/
- https://news.sophos.com/en-us/2021/04/13/compromised-exchange-server-hosting-cryptojacker-targeting-other-exchange-servers/
- https://twitter.com/JohnLaTwC/status/835149808817991680
- https://learn.microsoft.com/en-us/archive/blogs/pki/basic-crl-checking-with-certutil
- https://lolbas-project.github.io/lolbas/Binaries/Certutil/
author: Florian Roth (Nextron Systems), Jonhnathan Ribeiro, oscd.community
date: 2023-02-15
modified: 2024-03-05
tags:
- attack.defense-evasion
- attack.t1027
logsource:
  category: process_creation
  product: windows
detection:
  selection_img:
  - Image|endswith: '\certutil.exe'
  - OriginalFileName: 'CertUtil.exe'
  selection_cli:
    CommandLine|contains|windash:
    - '-decode '         # Decode Base64
    - '-decodehex '         # Decode Hex
  condition: all of selection_*
falsepositives:
- Unknown
level: medium
notes: |
  n
  ### Technical Context
  The Sigma rule for detecting the execution of `certutil.exe` with options to decode Base64 or Hex encoded files aims to highlight a common technique employed by attackers to obfuscate malicious payloads. By utilizing the `-decode` or `-decodehex` flags, adversaries can decode these encoded files before executing them, potentially leading to malicious activity within the environment. The rule operates by monitoring the process creation logs specifically for instances where `certutil.exe` is invoked with the aforementioned flags, capturing detailed command-line parameters alongside the executable's image path to ensure accurate detection. Logs from Windows Process Creation events are required, specifically those generated by Sysmon, enabling the SOC to identify system events across hosted solutions and endpoints. This detection relates to the MITRE ATT&CK tactic of Defense Evasion under the technique T1027.
  ### Investigation Steps
  - **Review Process Logs:** Check the Sysmon logs for details on `certutil.exe` executions. Pay special attention to the command line parameters and the associated process IDs to determine the origin and context of the execution.
    
  - **Correlate with EDR Events:** Utilize the EDR tool to gain additional insights into the process tree associated with the execution. Examine any parent processes that invoked `certutil.exe`, which may reveal if it was spawned by suspicious activity.
    
  - **Analyze Network Activity:** Look through network connection logs for any outbound communications that coincide with the timeframe of the `certutil.exe` execution. This may provide indications of data exfiltration or payload delivery related to the use of the tool.
  - **Scan with AV Solutions:** Perform a scan using your antivirus or malware detection tools on the decoded files. This can help confirm whether the files decoded through `certutil` contain known malicious signatures or unexpected content.
  ### Prioritization
  The alert's medium severity level is assigned due to the potential for serious implications, as decoding malicious payloads can facilitate subsequent intrusions or data breaches if left uninvestigated.
  ### Blind Spots and Assumptions
  This rule may not fire in situations where `certutil.exe` is executed with a different context or did not include the specified command-line arguments. It assumes that the logging for process creation is enabled in the monitored environments, and malicious actors could potentially evade detection by using legitimate command-line arguments or other base64-decoding tools available on Windows. Moreover, if the execution occurs from a process that is heuristically trusted, it could be overlooked.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environments and operational needs. Please communicate any changes to the detection engineering team.
