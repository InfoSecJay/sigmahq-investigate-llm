title: Suspicious Certreq Command to Download
id: 4480827a-9799-4232-b2c4-ccc6c4e9e12b
status: test
description: Detects a suspicious certreq execution taken from the LOLBAS examples,
  which can be abused to download (small) files
references:
- https://lolbas-project.github.io/lolbas/Binaries/Certreq/
author: Christian Burkard (Nextron Systems)
date: 2021-11-24
modified: 2022-06-13
tags:
- attack.command-and-control
- attack.t1105
logsource:
  category: process_creation
  product: windows
detection:
  selection_img:
  - Image|endswith: '\certreq.exe'
  - OriginalFileName: 'CertReq.exe'
  selection_cli:
    CommandLine|contains|all:
    - ' -Post '
    - ' -config '
    - ' http'
    - ' C:\windows\win.ini '
  condition: all of selection*
fields:
- CommandLine
- ParentCommandLine
falsepositives:
- Unlikely
level: high
notes: |
  ### Technical Context
  The Sigma rule titled "Suspicious Certreq Command to Download" is designed to detect potential abuse of the `certreq.exe` command-line utility in a Windows environment. This utility can be manipulated by attackers to download files from potentially malicious sources using the command-line parameters specified in the rule. The rule looks for process creation events where the `certreq.exe` executable is executed with specific options indicating a network request to an HTTP server, particularly where the command line contains `-Post`, `-config`, and references `http` or a suspicious local destination such as `C:\windows\win.ini`.
  The detection utilizes process creation logs from Windows, focusing on the `Image` and `CommandLine` fields to identify when `certreq.exe` is called under these conditions. This behavior aligns with the MITRE ATT&CK tactic for Command and Control (T1105), where remote attackers engage in the exfiltration or retrieval of files from compromised systems, highlighting the malicious actions associated with file downloads initiated through legitimate processes.
  ### Investigation Steps
  - **Verify Process Details:** Check the EDR or process monitoring tools for details on the `certreq.exe` process, including its parent process and the full command line used to see if it aligns with expected usage.
  - **Audit Network Activity:** Use network detection tools to examine outbound connections made during the execution of the command. Pay close attention to any HTTP requests made to potentially untrusted domains.
  - **Inspect File Changes:** Review file system logs to determine if there were any files downloaded to the target directory (e.g., `C:\windows\win.ini`) or any other directories commonly misused, and analyze the legitimacy of those files.
  - **Review User Activity:** Check for any logged user activity leading up to the command execution to identify any potential indicators of compromise, such as unauthorized access or unusual account behavior.
  ### Prioritization
  Given that the rule targets a potential command-and-control technique indicative of a malicious download, alerts generated by this rule should be treated with high severity priority, warranting immediate investigation due to the risk of a compromised system being exploited for data theft.
  ### Blind Spots and Assumptions
  There are a few recognized blind spots associated with this detection rule. The detection may not fire if the command is executed with slight variations that do not match the defined criteria, such as using alternative parameters or file paths. Additionally, legitimate use of `certreq.exe` by administrative processes or applications may produce false negatives if not documented properly within the organizational knowledge base. Analysts should be aware that attackers could utilize obfuscation techniques or legitimate administrative tools under the guise of normal operations, making it critical to conduct thorough investigation across the environment.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
