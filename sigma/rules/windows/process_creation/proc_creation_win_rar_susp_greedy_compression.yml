title: Suspicious Greedy Compression Using Rar.EXE
id: afe52666-401e-4a02-b4ff-5d128990b8cb
status: test
description: Detects RAR usage that creates an archive from a suspicious folder, either
  a system folder or one of the folders often used by attackers for staging purposes
references:
- https://decoded.avast.io/martinchlumecky/png-steganography
author: X__Junior (Nextron Systems), Florian Roth (Nextron Systems)
date: 2022-12-15
modified: 2024-01-02
tags:
- attack.execution
- attack.t1059
logsource:
  product: windows
  category: process_creation
detection:
    # Example : rar.exe a -m5 -r -y -ta20210204000000 -hp1qazxcde32ws -v2560k Asia1Dpt-PC-c.rar c:\\*.doc c:\\*.docx c:\\*.xls c:\\*.xlsx c:\\*.pdf c:\\*.ppt c:\\*.pptx c:\\*.jpg c:\\*.txt >nul
  selection_opt_1:
  - Image|endswith: '\rar.exe'
  - Description: 'Command line RAR'
  selection_opt_2:
    CommandLine|contains:
    - '.exe a '
    - ' a -m'
  selection_cli_flags:
    CommandLine|contains|all:
    - ' -hp'         # password
    - ' -r '         # recursive
  selection_cli_folders:
    CommandLine|contains:
    - ' ?:\\\*.'
    - ' ?:\\\\\*.'
    - ' ?:\$Recycle.bin\'
    - ' ?:\PerfLogs\'
    - ' ?:\Temp'
    - ' ?:\Users\Public\'
    - ' ?:\Windows\'
    - ' %public%'
  condition: 1 of selection_opt_* and all of selection_cli_*
falsepositives:
- Unknown
level: high
notes: |
  ### Technical Context
  The Sigma rule titled "Suspicious Greedy Compression Using Rar.EXE" is designed to identify potentially malicious use of the RAR compression tool in a Windows environment. It specifically looks for activities involving the execution of `rar.exe` in conjunction with certain command-line parameters that are often associated with malicious behavior. This includes compressing files from directories that are commonly exploited by attackers, such as system directories or folders where sensitive information may reside (e.g., `$Recycle.bin`, `Temp`, `Public`, and `Windows`). The primary detection mechanism relies on process creation logs, capturing both the invocation of RAR and the specific arguments used during its execution. This aligns with the MITRE ATT&CK technique for execution (T1059), which denotes the use of scripting languages or command-line interfaces by adversaries to execute malicious payloads.
  ### Investigation Steps
  - **Check Process Creation Logs**: Utilize EDR tools to examine the process creation logs for instances of `rar.exe` and capture the associated command-line arguments for further analysis.
  - **Review File System Activity**: Conduct a review of the directories specified in the command line (`$Recycle.bin`, `Temp`, etc.) to identify any files that were compressed and assess their content for sensitive or suspicious data.
  - **Correlate with User Activity**: Use proxy logs or VPN logs to determine whether the user account executing the RAR command exhibited unusual or unauthorized behavior prior to the alert.
  - **Endpoint Analysis**: Run a scan on the endpoint where the RAR command was executed using AV tools to detect any signs of payloads or compromise related to the event.
  ### Prioritization
  The alert generated by this rule is considered high priority due to the potential for data exfiltration or compromise, especially when RAR is used inappropriately on sensitive system folders.
  ### Blind spots and Assumptions
  This rule may not fire on legitimate uses of RAR in environments where employees are authorized to create compressed archives of system files or user data. Furthermore, if an adversary renames their malicious executable or obfuscates command-line arguments, the rule could be bypassed. Additionally, if certain file extensions are excluded from monitoring or if the execution takes place on systems without Sysmon or similar logging capabilities, the detection may not trigger.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
