title: Outlook EnableUnsafeClientMailRules Setting Enabled
id: 55f0a3a1-846e-40eb-8273-677371b8d912
related:
- id: 6763c6c8-bd01-4687-bc8d-4fa52cf8ba08     # Registry variation
  type: similar
status: test
description: Detects an attacker trying to enable the outlook security setting "EnableUnsafeClientMailRules"
  which allows outlook to run applications or execute macros
references:
- https://www.fireeye.com/blog/threat-research/2018/12/overruled-containing-a-potentially-destructive-adversary.html
- https://speakerdeck.com/heirhabarov/hunting-for-persistence-via-microsoft-exchange-server-or-outlook?slide=44
- https://support.microsoft.com/en-us/topic/how-to-control-the-rule-actions-to-start-an-application-or-run-a-macro-in-outlook-2016-and-outlook-2013-e4964b72-173c-959d-5d7b-ead562979048
author: Markus Neis, Nasreddine Bencherchali (Nextron Systems)
date: 2018-12-27
modified: 2023-02-09
tags:
- attack.execution
- attack.t1059
- attack.t1202
logsource:
  category: process_creation
  product: windows
detection:
  selection:
    CommandLine|contains: '\Outlook\Security\EnableUnsafeClientMailRules'
  condition: selection
falsepositives:
- Unknown
level: high
notes: |
  ### Technical Context
  The Sigma rule titled “Outlook EnableUnsafeClientMailRules Setting Enabled” is designed to detect the modification of Microsoft Outlook's security settings that allow potentially unsafe operations, such as executing macros or running external applications from emails. This modification involves the registry key specifically referencing enabling "Unsafe Client Mail Rules," located under the specified path. The rule operates by monitoring process creation logs, particularly the command-line parameters used during the execution of Outlook. By examining these command lines for the presence of the phrase `\Outlook\Security\EnableUnsafeClientMailRules`, the rule aims to catch malicious actors attempting to exploit this setting to execute their payloads or maintain persistence. This falls under the MITRE ATT&CK tactic of Execution (T1059: Command-Line Interface) and the technique of exploitation of software vulnerabilities (T1202).
  ### Investigation Steps
  - **Check EDR Alerts:** Review alerts generated by your Endpoint Detection and Response (EDR) solution related to suspicious process creation events involving Outlook and the specific command line identified in the rule.
  - **Examine Windows Event Logs:** Analyze the Windows Security and System logs for any unusual account activity or changes made around the same time as the detected rule to correlate potential unauthorized access to the system.
  - **Review Registry Changes:** Look for modifications to the Outlook registry keys associated with Unsafe Client Mail Rules either via Windows Registry logs or directly, which may indicate tampering by an adversary.
  - **Network Traffic Analysis:** Use the Network Detection and Response (NDR) tools to analyze outbound connections initiated by Outlook during the alerted period, looking for any suspicious activities or connections that could indicate data exfiltration or communication with a command and control server.
  ### Prioritization
  This alert is classified as high priority due to the potential severity of enabling unsafe client mail rules in Outlook, which can allow adversaries to execute malicious macros, ultimately compromising systems and data integrity within an enterprise environment.
  ### Blind Spots and Assumptions
  The rule may fail to trigger if the process modifications occur without using the specified command line or if registry changes are done directly through methods that do not generate process creations logged by the system. Additionally, an attacker might leverage legitimate tools or processes to obfuscate their actions. It is assumed that monitoring for command-line changes and registry access is configured adequately; however, these mechanisms could be circumvented if a user or process has elevated privileges. 
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
