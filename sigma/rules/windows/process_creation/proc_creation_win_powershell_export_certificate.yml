title: Certificate Exported Via PowerShell
id: 9e716b33-63b2-46da-86a4-bd3c3b9b5dfb
related:
- id: aa7a3fce-bef5-4311-9cc1-5f04bb8c308c
  type: similar
status: test
description: Detects calls to cmdlets that are used to export certificates from the
  local certificate store. Threat actors were seen abusing this to steal private keys
  from compromised machines.
references:
- https://us-cert.cisa.gov/ncas/analysis-reports/ar21-112a
- https://learn.microsoft.com/en-us/powershell/module/pki/export-pfxcertificate?view=windowsserver2022-ps
- https://www.splunk.com/en_us/blog/security/breaking-the-chain-defending-against-certificate-services-abuse.html
author: Nasreddine Bencherchali (Nextron Systems)
date: 2023-05-18
tags:
- attack.credential-access
- attack.execution
- attack.t1552.004
- attack.t1059.001
logsource:
  product: windows
  category: process_creation
detection:
  selection:
    CommandLine|contains:
    - 'Export-PfxCertificate '
    - 'Export-Certificate '
  condition: selection
falsepositives:
- Legitimate certificate exports by administrators. Additional filters might be required.
level: medium
notes: |
  ### Technical Context
  The Sigma rule "Certificate Exported Via PowerShell" is designed to detect potential adversarial behavior by monitoring for specific PowerShell cmdlets that are used to export certificates from the local certificate store. Adversaries sometimes use these functionalities to steal private keys from compromised machines, which can greatly compromise security. The rule inspects process creation logs to identify instances where commands containing `Export-PfxCertificate` or `Export-Certificate` are executed. By focusing on these relevant cmdlets, the detection is aimed at uncovering suspicious activities associated with credential access, linking the findings to the MITRE ATT&CK tactic of Credential Access (T1552.004: Unauthenticating Exfiltration of Credentials) and Execution (T1059.001: Command and Scripting Interpreter).
  The data sources utilized for this detection rule include Windows Event Logs, specifically the process creation logs generated by Sysmon. Investigating the command-line parameters of PowerShell execution is critical in understanding the context of the operations being performed and identifying potentially unauthorized attempts to export sensitive certificates.
  ### Investigation Steps
  - **Review EDR Data**: Check endpoint detection and response (EDR) data for any anomalous PowerShell activity, especially focusing on the machine and user ID tied to the alert.
    
  - **Analyze Process Creation Logs**: Investigate the corresponding process creation logs to determine the parent-child relationships of PowerShell processes to understand the execution chain.
    
  - **Correlate with User Behavior**: Use user activity logs to see if the user triggering this command has legitimate business needs or recent unusual actions that could indicate a compromised account.
    
  - **Inspect Network Connections**: Examine network logs for any unauthorized outbound connections made from the affected machine at the time of the alert, which could indicate exfiltration of the exported certificates.
  ### Prioritization
  Given the nature of this alert, it is categorized as medium severity due to the potential for significant security risks associated with improper certificate management and credential theft in enterprise environments. Quick response to this alert is recommended to mitigate any possible data breaches.
  ### Blind Spots and Assumptions
  Some blind spots associated with this detection rule include the possibility of legitimate users exporting certificates during routine operations, which might lead to false positives. The rule relies on the assumption that the command line arguments are not altered in an attempt to obscure malicious activity. Furthermore, users with elevated privileges may execute such commands without triggering security protocolsâ€”meaning alerting mechanisms could fail in environments where PowerShell is routinely used for administrative tasks.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
