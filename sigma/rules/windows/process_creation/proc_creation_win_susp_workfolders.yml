title: Execution via WorkFolders.exe
id: 0bbc6369-43e3-453d-9944-cae58821c173
status: test
description: Detects using WorkFolders.exe to execute an arbitrary control.exe
references:
- https://twitter.com/elliotkillick/status/1449812843772227588
author: Maxime Thiebaut (@0xThiebaut)
date: 2021-10-21
modified: 2022-12-25
tags:
- attack.defense-evasion
- attack.t1218
logsource:
  category: process_creation
  product: windows
detection:
  selection:
    Image|endswith: '\control.exe'
    ParentImage|endswith: '\WorkFolders.exe'
  filter:
    Image: 'C:\Windows\System32\control.exe'
  condition: selection and not filter
falsepositives:
- Legitimate usage of the uncommon Windows Work Folders feature.
level: high
notes: |
  n
  ### Technical Context
  The Sigma rule titled "Execution via WorkFolders.exe" detects potential malicious activity involving the legitimate Windows application `WorkFolders.exe`, which is used for synchronizing files across devices. This detection works by monitoring process creation logs specifically for instances where `control.exe` (a system utility for configuring Windows settings) is executed with `WorkFolders.exe` as its parent process. The rule checks whether the command to run `control.exe` does not originate from its standard location (`C:\Windows\System32\`) to filter out legitimate behaviors. This kind of tactic is associated with the MITRE ATT&CK framework under the tactic "Defense Evasion" and technique "T1218" (Signed Binary Proxy Execution), highlighting potential abuse where an attacker intentionally uses benign-looking processes to execute unauthorized actions.
  This rule leverages Windows process creation logs, enabling the detection of abnormal execution chains that can signal an attempted exploitation or evasion of traditional security controls. By analyzing both the image names and parent-child relationship between processes, analysts can distinguish malicious behavior masquerading behind legitimate process names.
  ### Investigation Steps
  - **Check Process Execution Context:** Use your EDR to examine the execution context of `WorkFolders.exe` and `control.exe`. Review the process tree to confirm the history of process creation and identify any suspicious parent processes.
  - **Review Command-Line Parameters:** Investigate any command-line arguments that were passed to `control.exe` using EDR or Sysmon logs. This can provide insights into the actions being performed and whether they deviate from normal operational parameters.
  - **Analyze Event Logs:** Query Windows Event Logs (Security and Application) for any unusual logins, access patterns, or related activities around the time of the alert. Pay particular attention to events that suggest privilege escalation or unusual user behavior.
  - **Assess Legitimate Usage:** Cross-reference the occurrences with knowledge of normal organizational use of `WorkFolders.exe`. Leverage user training or documentation to ascertain if this tool is deployed within the environment and assess any legitimate use cases.
  ### Prioritization
  The alert generated by this detection rule is classified as high severity due to its potential to indicate an evasion technique employed by threat actors to disguise malicious activities using trusted Windows utilities, which can facilitate significant risk if successfully executed in an enterprise environment.
  ### Blind Spots and Assumptions
  This rule may not fire in scenarios where adversaries execute `control.exe` from its standard directory, or by using legitimate administrative privileges that allow for expected usage patterns, thus evading detection. Additionally, the rule assumes that monitoring for `WorkFolders.exe` is properly configured in the enterprise environment; if not, these activities may go undetected. Furthermore, any updates or legitimate modifications to Windows that alter the behavior of the Work Folders feature may result in false negatives or positives.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
