title: PUA - AdFind Suspicious Execution
id: 9a132afa-654e-11eb-ae93-0242ac130002
related:
- id: 455b9d50-15a1-4b99-853f-8d37655a4c1b
  type: similar
- id: 75df3b17-8bcc-4565-b89b-c9898acef911
  type: obsolete
status: test
description: Detects AdFind execution with common flags seen used during attacks
references:
- https://www.joeware.net/freetools/tools/adfind/
- https://thedfirreport.com/2020/05/08/adfind-recon/
- https://thedfirreport.com/2021/01/11/trickbot-still-alive-and-well/
- https://www.microsoft.com/security/blog/2021/01/20/deep-dive-into-the-solorigate-second-stage-activation-from-sunburst-to-teardrop-and-raindrop/
- https://social.technet.microsoft.com/wiki/contents/articles/7535.adfind-command-examples.aspx
- https://github.com/center-for-threat-informed-defense/adversary_emulation_library/blob/bf62ece1c679b07b5fb49c4bae947fe24c81811f/fin6/Emulation_Plan/Phase1.md
- https://github.com/redcanaryco/atomic-red-team/blob/0f229c0e42bfe7ca736a14023836d65baa941ed2/atomics/T1087.002/T1087.002.md#atomic-test-7---adfind---enumerate-active-directory-user-objects
author: Janantha Marasinghe (https://github.com/blueteam0ps), FPT.EagleEye Team, omkar72,
  oscd.community
date: 2021-02-02
modified: 2023-03-05
tags:
- attack.discovery
- attack.t1018
- attack.t1087.002
- attack.t1482
- attack.t1069.002
- stp.1u
logsource:
  category: process_creation
  product: windows
detection:
  selection:
    CommandLine|contains:
    - 'domainlist'
    - 'trustdmp'
    - 'dcmodes'
    - 'adinfo'
    - ' dclist '
    - 'computer_pwdnotreqd'
    - 'objectcategory='
    - '-subnets -f'
    - 'name="Domain Admins"'
    - '-sc u:'
    - 'domainncs'
    - 'dompol'
    - ' oudmp '
    - 'subnetdmp'
    - 'gpodmp'
    - 'fspdmp'
    - 'users_noexpire'
    - 'computers_active'
    - 'computers_pwdnotreqd'
  condition: selection
falsepositives:
- Legitimate admin activity
level: high
notes: |
  ### Technical Context
  The Sigma rule "PUA 
  - AdFind Suspicious Execution" is designed to detect potentially unauthorized or malicious executions of the AdFind tool, commonly used during reconnaissance phases of cyber attacks. This tool is often employed by attackers to query Active Directory for sensitive information. The detection focuses on specific command-line parameters that are commonly associated with adversarial activities, such as obtaining lists of domain users, computers, and various Active Directory attributes.
  This rule primarily leverages Windows process creation logs to identify instances where the AdFind command is executed with suspicious flags or parameters. It searches for particular keywords in the command-line input, signaling potentially malicious intents, which are critical for identifying attacks based on reconnaissance tactics outlined in the MITRE ATT&CK framework, specifically under tactics and techniques related to Discovery (T1018, T1087.002) and Credential Access (T1482, T1069.002).
  ### Investigation Steps
  - **Check Process Creation Logs:** Utilize the EDR or Sysmon logs to locate the process creation event for AdFind and review the corresponding command-line arguments to confirm whether they match any suspicious patterns outlined in the rule.
  - **Validate User Context:** Investigate the user account executing the AdFind command. Check if it is a legitimate admin account performing authorized activities or a potentially compromised account.
  - **Review Network Traffic:** Examine outbound connections related to the identified AdFind process using network logs (NDR) to determine if any data exfiltration or communication with known malicious C2 servers occurred.
  - **Conduct Threat Hunting in Active Directory:** Leverage insights from Active Directory logs to verify if the actions taken by the tool resulted in unauthorized information retrieval or any modifications to accounts or permissions.
  ### Prioritization
  Given the high severity level of alerts generated by this rule, a detection signifies possible reconnaissance activities, which could precede a more extensive attack. Immediate investigation is necessary to assess whether sensitive information has been accessed or exposed.
  ### Blind Spots and Assumptions
  There are scenarios where this rule may not trigger, such as variations in command usage not accounted for in the detection criteria, legitimate administrative use cases of AdFind, or the use of obfuscation techniques by an adversary to mask command-line parameters. Additionally, the rule relies on proper logging being enabled; if Windows process creation logging is not active, detection may fail. Analysts should be aware of these potential gaps to enhance their investigation framework effectively.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
