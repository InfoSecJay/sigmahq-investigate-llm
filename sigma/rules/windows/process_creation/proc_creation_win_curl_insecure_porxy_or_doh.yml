title: Insecure Proxy/DOH Transfer Via Curl.EXE
id: 2c1486f5-02e8-4f86-9099-b97f2da4ed77
status: test
description: Detects execution of "curl.exe" with the "insecure" flag over proxy or
  DOH.
references:
- https://curl.se/docs/manpage.html
author: Nasreddine Bencherchali (Nextron Systems)
date: 2023-07-27
tags:
- attack.execution
logsource:
  product: windows
  category: process_creation
detection:
  selection_img:
  - Image|endswith: '\curl.exe'
  - OriginalFileName: 'curl.exe'
  selection_cli:
    CommandLine|contains:
    - '--doh-insecure'
    - '--proxy-insecure'
  condition: all of selection_*
falsepositives:
- Access to badly maintained internal or development systems
level: medium
notes: |
  n
  ### Technical Context
  The detection rule for "Insecure Proxy/DOH Transfer Via Curl.EXE" is designed to identify potentially dangerous uses of the `curl.exe` command-line tool on Windows systems. Specifically, it focuses on instances where `curl.exe` is executed with the `--doh-insecure` or `--proxy-insecure` flags, which could indicate unauthorized attempts to bypass security protocols while communicating over the network. This behavior can be indicative of an adversary seeking to exfiltrate sensitive data through DNS-over-HTTPS or use insecure proxies to obscure their activities. The rule leverages process creation logs to monitor instances of `curl.exe`, particularly looking at command line parameters that reveal insecure configurations. This aligns with the MITRE ATT&CK tactics under `Execution` (T1203), as it highlights malicious or risky execution methods that adversaries might employ.
  ### Investigation Steps
  - **Collect Process Creation Logs:** Utilize EDR tools to pull detailed logs of process creation events, filtering specifically for `curl.exe` execution and the associated command line usage including `--doh-insecure` and `--proxy-insecure`.
    
  - **Analyze Network Traffic:** Check the network logs from the NGFW or NDR tools to identify if any corresponding network connections were made to suspicious external destinations immediately following the execution of the detected command. 
  - **Investigate Source Context:** Review application and system logs to ascertain whether the execution of `curl.exe` originated from a user account with appropriate privileges, and whether it was executed in a sensitive context or time frame.
  - **Review for False Positives:** Cross-reference the findings with potential false positives, such as legitimate accesses to internal systems, and document any known infrastructure that may trigger the detection rule without malicious intent.
  ### Prioritization
  The alert generated by this rule is categorized as medium severity in an enterprise environment due to the elevated risk associated with using insecure communication methods, which could expose sensitive data and facilitate further attacks if exploited by malicious actors.
  ### Blind Spots and Assumptions
  This rule may not fire if the execution of `curl.exe` occurs without the specified insecure flags, or if other tools are used to perform similar actions without invoking `curl.exe`. Additionally, it assumes that the necessary logging configuration is enabled to capture process creation details; if logging is not configured properly, such events may go undetected. Adversaries may also use alternative methods or obfuscation techniques to bypass detection.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
