title: AgentExecutor PowerShell Execution
id: 7efd2c8d-8b18-45b7-947d-adfe9ed04f61
related:
- id: c0b40568-b1e9-4b03-8d6c-b096da6da9ab
  type: similar
status: test
description: Detects execution of the AgentExecutor.exe binary. Which can be abused
  as a LOLBIN to execute powershell scripts with the ExecutionPolicy "Bypass" or any
  binary named "powershell.exe" located in the path provided by 6th positional argument
author: Nasreddine Bencherchali (Nextron Systems), memory-shards
references:
- https://twitter.com/lefterispan/status/1286259016436514816
- https://lolbas-project.github.io/lolbas/OtherMSBinaries/Agentexecutor/
- https://learn.microsoft.com/en-us/mem/intune/apps/intune-management-extension
- https://twitter.com/jseerden/status/1247985304667066373/photo/1
date: 2022-12-24
modified: 2024-08-07
tags:
- attack.defense-evasion
- attack.t1218
logsource:
  category: process_creation
  product: windows
detection:
  selection_img:
  - Image: '\AgentExecutor.exe'
  - OriginalFileName: 'AgentExecutor.exe'
  selection_cli:
        # Example:
        #   AgentExecutor.exe -powershell [scriptPath] [outputFilePath] [errorFilePath] [timeoutFilePath] [timeoutSeconds] [powershellPath] [enforceSignatureCheck] [runAs32BitOn64]
        # Note:
        #   - If [timeoutSeconds] is NULL then it defaults to 60000
        #   - If [enforceSignatureCheck] is:
        #       - "NULL" or "1" then a PowerShell instance is spawned with the args: "-NoProfile -executionPolicy allsigned -file "
        #       - Else a PowerShell instance is spawned with the args: "-NoProfile -executionPolicy bypass -file "
        #   - [powershellPath] is always concatendated to "powershell.exe"
    CommandLine|contains:
    - ' -powershell'         # Also covers the "-powershellDetection" flag
    - ' -remediationScript'
  filter_main_intune:
    ParentImage|endswith: '\Microsoft.Management.Services.IntuneWindowsAgent.exe'
  condition: all of selection_* and not 1 of filter_main_*
falsepositives:
- Legitimate use via Intune management. You exclude script paths and names to reduce
  FP rate
level: medium
notes: |
  n
  ### Technical Context
  The "AgentExecutor PowerShell Execution" detection rule identifies suspicious executions of the AgentExecutor.exe binary, which can serve as a living-off-the-land binary (LOLBIN) for executing PowerShell scripts with the ExecutionPolicy set to "Bypass." The rule specifically looks for process creation events where AgentExecutor.exe is launched with command-line arguments indicative of PowerShell script execution, such as the presence of the `-powershell` or `-remediationScript` flags. This detection leverages Windows process creation logs as the primary data source, focusing on the properties of the executed process, including its command-line parameters and the parent image that spawned it. By monitoring these logs, security teams can identify potential evasion tactics employed by adversaries. This rule relates to the MITRE ATT&CK tactics of Defense Evasion (T1218), highlighting the importance of monitoring commonly abused execution methods within environments utilizing PowerShell.
  ### Investigation Steps
  - **Review Event Logs:** Check Windows Security and System event logs for process creation events related to AgentExecutor.exe around the time of the alert to gather context on the execution.
  - **Analyze Command-Line Arguments:** Investigate the command-line parameters used in the execution, particularly the presence of the PowerShell flag and any specified script paths to determine if they indicate malicious activity.
  - **Correlate with EDR Data:** Use endpoint detection and response (EDR) solutions to review the behavior of the AgentExecutor process, looking for unusual activity or behavior that deviates from typical operational patterns.
  - **Investigate Parent Process:** Examine the parent process, specifically any instances of Microsoft.Management.Services.IntuneWindowsAgent.exe, to differentiate between legitimate usage and potential abuse.
  ### Prioritization
  The alert is categorized as medium severity due to the dual-use nature of AgentExecutor.exe; while it can be utilized legitimately for management purposes, its capabilities also present significant risks when abused for malicious actions.
  ### Blind Spots and Assumptions
  There are potential blind spots with this rule, including false positives generated by legitimate usage within Intune management for script execution. The rule assumes that the AgentExecutor.exe will be executed with specific flags indicative of misuse; if an adversary renames the binary or alters command-line parameters significantly, the detection may fail. Additionally, if the PowerShell scripts are executed without using the AgentExecutor, the rule will not trigger, potentially allowing for undetected malicious activity.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
