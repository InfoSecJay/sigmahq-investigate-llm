title: UAC Bypass via Windows Firewall Snap-In Hijack
id: e52cb31c-10ed-4aea-bcb7-593c9f4a315b
status: test
description: Detects attempts to bypass User Account Control (UAC) by hijacking the
  Microsoft Management Console (MMC) Windows Firewall snap-in
references:
- https://www.elastic.co/guide/en/security/current/uac-bypass-via-windows-firewall-snap-in-hijack.html#uac-bypass-via-windows-firewall-snap-in-hijack
author: Tim Rauch, Elastic (idea)
date: 2022-09-27
tags:
- attack.privilege-escalation
- attack.t1548
logsource:
  category: process_creation
  product: windows
detection:
  selection:
    ParentImage|endswith: '\mmc.exe'
    ParentCommandLine|contains: 'WF.msc'
  filter:
    Image|endswith: '\WerFault.exe'
  condition: selection and not filter
falsepositives:
- Unknown
level: medium
notes: |
  ### Technical Context
  This detection rule identifies potential User Account Control (UAC) bypass attempts through a technique known as Windows Firewall snap-in hijacking. The rule analyzes process creation logs focusing on instances where a process is spawned from the Microsoft Management Console (MMC) with a command line referencing 'WF.msc', which is related to the Windows Firewall settings. If the newly created process is 'WerFault.exe', the rule identifies this activity as potentially suspicious because 'WerFault.exe' is commonly exploited in UAC bypass techniques.
  This rule aligns with the MITRE ATT&CK framework, specifically the Privilege Escalation tactic (T1548), which covers techniques that adversaries employ to escalate their privileges on a compromised system. By monitoring process creation events, the rule aims to alert analysts to behavior indicative of malicious intent, enabling timely investigation and remediation.
  ### Investigation Steps
  - **Review Process Creation Logs:** Investigate the process creation logs in the EDR platform to confirm the presence of 'mmc.exe' as the parent process and check the command line parameters for 'WF.msc'.
  - **Analyze Network Activity:** Use network logs to evaluate any unusual outbound connections made by the suspected processes to identify potential data exfiltration or command-and-control communications.
  - **Examine User Account Control Events:** Check Windows Security logs for UAC-related events during the timeframe of the alert to assess whether UAC prompts were triggered or bypassed.
  - **Conduct File Integrity Checks:** Review the integrity of the files involved (i.e., 'WerFault.exe') by comparing them against known good baselines, as adversaries often replace legitimate executables with malicious ones.
  ### Prioritization
  Alerts generated by this rule are rated as medium severity due to the potential impact of UAC bypasses, which can allow unauthorized users to gain elevated privileges, leading to further system compromise or data exfiltration in an enterprise environment.
  ### Blind Spots and Assumptions
  This rule assumes that UAC is enabled and that the Windows Firewall snap-in could be targeted. However, it may not fire if an adversary employs obscured techniques that do not reference 'WF.msc' or bypasses UAC via other methods not captured in the logs. Additionally, legitimate processes may trigger the rules under rare conditions, leading to potential false positives.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
