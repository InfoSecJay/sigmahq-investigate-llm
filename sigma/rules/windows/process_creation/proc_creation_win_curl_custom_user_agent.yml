title: Curl Web Request With Potential Custom User-Agent
id: 85de1f22-d189-44e4-8239-dc276b45379b
status: test
description: Detects execution of "curl.exe" with a potential custom "User-Agent".
  Attackers can leverage this to download or exfiltrate data via "curl" to a domain
  that only accept specific "User-Agent" strings
references:
- https://labs.withsecure.com/publications/fin7-target-veeam-servers
- https://github.com/WithSecureLabs/iocs/blob/344203de742bb7e68bd56618f66d34be95a9f9fc/FIN7VEEAM/iocs.csv
author: Nasreddine Bencherchali (Nextron Systems)
date: 2023-07-27
tags:
- attack.execution
logsource:
  category: process_creation
  product: windows
detection:
  selection_img:
  - Image|endswith: '\curl.exe'
  - OriginalFileName: 'curl.exe'
  selection_header:
    CommandLine|re: '\s-H\s'     # Must be Regex as the flag needs to be case sensitive
    CommandLine|contains: 'User-Agent:'
  condition: all of selection_*
falsepositives:
- Unknown
level: medium
notes: |
  ### Technical Context
  This Sigma rule detects the execution of `curl.exe` when it employs a custom "User-Agent" HTTP header. Attackers frequently utilize this capability to download or exfiltrate data from specific domains that only respond to requests containing particular User-Agent strings, thereby evading standard security controls. To achieve this, the rule looks for process creation events, specifically targeting `curl.exe`. The detection leverages command-line parameters to identify the presence of the `-H` flag which denotes the use of custom headers and checks for the inclusion of the "User-Agent" string. The relevant data sources for this detection include process creation logs generated by Windows, where the command line execution parameters are recorded. This aligns with the MITRE ATT&CK tactic of "Execution" and technique TA0002.
  ### Investigation Steps
  - **Check EDR for the execution context:** Investigate the `curl.exe` execution context within the endpoint's EDR solution to confirm whether the execution was authorized or part of legitimate operations.
  - **Review process lineage:** Analyze the parent process of `curl.exe` in Windows Process Explorer or your EDR tool to determine the source of execution and any initial stage of potentially malicious behavior.
  - **Analyze network connections:** Use network logs to assess any subsequent outbound connections established by `curl.exe` to ensure they do not resolve to known malicious domains or indicators of compromise.
  - **Inspect logs for User-Agent string:** Review application or proxy logs for incoming requests that matched the patterns detected, focusing on any unusual HTTP requests that may use custom User-Agent strings.
  ### Prioritization
  The severity level is medium, indicating that while this activity is not inherently malicious, it could signify potential data exfiltration or command and control traffic, which requires a timely investigation to ascertain the intent behind its execution.
  ### Blind Spots and Assumptions
  This rule may not trigger for instances where alternative methods or tools are used to mimic `curl.exe`, such as PowerShellâ€™s `Invoke-WebRequest` or if the command is obfuscated in ways not captured by the command-line regex. Additionally, if the system's monitoring is improperly configured or if `curl` is treated as a valid application without scrutiny, detection may fail. The assumption is that `curl.exe` is present and actively monitored on the endpoint in question.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
