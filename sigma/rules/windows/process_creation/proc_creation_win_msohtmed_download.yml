title: Arbitrary File Download Via MSOHTMED.EXE
id: 459f2f98-397b-4a4a-9f47-6a5ec2f1c69d
status: test
description: Detects usage of "MSOHTMED" to download arbitrary files
references:
- https://github.com/LOLBAS-Project/LOLBAS/pull/238/files
author: Nasreddine Bencherchali (Nextron Systems)
date: 2022-08-19
modified: 2023-11-09
tags:
- attack.defense-evasion
- attack.execution
- attack.t1218
logsource:
  category: process_creation
  product: windows
detection:
  selection_img:
  - Image|endswith: '\MSOHTMED.exe'
  - OriginalFileName: 'MsoHtmEd.exe'
  selection_cli:
    CommandLine|contains:
    - 'ftp://'
    - 'http://'
    - 'https://'
  condition: all of selection_*
falsepositives:
- Unknown
level: medium
notes: |
  ### Technical Context
  The Sigma rule "Arbitrary File Download Via MSOHTMED.EXE" is designed to detect potential malicious activity involving the `MSOHTMED.EXE` process, which is a component associated with Microsoft Office. This rule identifies instances where this executable is used to download arbitrary files from external sources, specifically through command-line parameters containing protocols such as FTP or HTTP. The detection is achieved by analyzing process creation logs from Windows, particularly focusing on the image name and original file name of the process along with its command-line arguments. Such behavior is indicative of misuse of trusted applications for malicious purposes, aligning with the MITRE ATT&CK tactics of Defense Evasion (T1203) and Execution (T1218).
  The detection mechanism relies primarily on the `process_creation` log source, which provides details on executed processes including their parameters, thereby allowing analysts to track and respond to suspicious file downloads initiated by legitimate processes. By setting conditions to look for specific execution traits of `MSOHTMED.EXE`, the rule aims to proactively identify potential security incidents involving the theft of sensitive data or the introduction of malware via unintended channels.
  ### Investigation Steps
  - **Confirm Process Origin:** Check `Windows Security` event logs for the creation of the `MSOHTMED.EXE` process to confirm its legitimacy and correlate it with user activity.
  - **Analyze Command-Line Arguments:** Utilize `EDR` tools to capture the command-line arguments used at the time of execution to investigate any unusual URLs or protocols that might indicate malicious activity.
  - **Inspect Network Activity:** Query `NDR` or `Proxy` logs to identify outbound requests made by the `MSOHTMED.EXE` process, looking for connections to suspicious or unknown destinations.
  - **Cross-Reference with Threat Intelligence:** Use threat intelligence feeds to assess whether the associated URLs or IP addresses have been reported for malware delivery or other malicious purposes.
  ### Prioritization
  The alert generated by this rule is classified as medium severity due to the potential risk associated with arbitrary file downloads via a trusted process, which could indicate deliberate evasion techniques by an adversary seeking to conduct further malicious activities within the network.
  ### Blind Spots and Assumptions
  This rule may not fire if `MSOHTMED.EXE` is not present in the environment or if it has not been invoked to download files through the specified protocols. Additionally, adversaries could employ obfuscation techniques or alternative methods of execution that bypass this detection method, such as renaming the executable or utilizing different file download mechanisms. It is crucial for detection engineers to validate process whitelist policies and monitor for other legitimate applications that may exhibit similar behaviors.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
