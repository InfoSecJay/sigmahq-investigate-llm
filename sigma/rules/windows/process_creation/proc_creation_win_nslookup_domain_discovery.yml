title: Network Reconnaissance Activity
id: e6313acd-208c-44fc-a0ff-db85d572e90e
status: test
description: Detects a set of suspicious network related commands often used in recon
  stages
references:
- https://thedfirreport.com/2022/02/07/qbot-likes-to-move-it-move-it/
author: Florian Roth (Nextron Systems)
date: 2022-02-07
tags:
- attack.discovery
- attack.t1087
- attack.t1082
- car.2016-03-001
logsource:
  category: process_creation
  product: windows
detection:
  selection:
    CommandLine|contains|all:
    - 'nslookup'
    - '_ldap._tcp.dc._msdcs.'
  condition: selection
falsepositives:
- False positives depend on scripts and administrative tools used in the monitored
  environment
level: high
notes: |
  ### Technical Context
  This detection rule is designed to identify network reconnaissance activities, specifically through the execution of commands that are indicative of efforts to gather information about the network infrastructure. The rule monitors Windows process creation logs for command-line invocations containing the command `nslookup` followed by the DNS query pattern associated with domain controllers (`_ldap._tcp.dc._msdcs.`). This pattern is often employed by attackers during the reconnaissance phase to enumerate Domain Controllers and gather information about the network structure. By leveraging Process Creation logs from Windows, the rule correlates command-line activity that could suggest potential malicious intent, aligning with the MITRE ATT&CK tactics of Discovery (Tactic: Discovery, Technique: T1087 and T1082). 
  ### Investigation Steps
  - **Review Alert Context:** Check the alert generated by the SIEM or EDR system for details on when and where the command was executed. Understanding the user account involved is critical for determining legitimacy.
    
  - **Inspect Command-Line Arguments:** Utilize EDR solutions to extract the complete command line that triggered the alert, paying close attention to any additional parameters that might indicate further malicious activity.
  - **Cross-Reference Network Logs:** Query the DNS logs to correlate the detected `nslookup` command with DNS queries made during the same timeframe. This will help establish if there were any genuine administrative actions or further suspicious activities.
  - **Review Related Process Activity:** Investigate other processes spawned by the user at the time of the command execution. Look for any unusual behaviors or relationships that could signify compromise or automation by malicious actors.
  ### Prioritization
  This alert is rated as high severity due to the nature of reconnaissance activities, which often precede more damaging attack phases, including lateral movement and exploitation if not contained.
  ### Blind Spots and Assumptions
  The rule may not fire in environments where administrative scripts frequently run valid `nslookup` commands for routine network management, leading to potential false positives. Additionally, sophisticated attackers might obfuscate their command usage or employ other tools that do not trigger this detection. It is assumed that the environment has standard logging practices in place; if logging is minimal or disabled, the detection may fail.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
