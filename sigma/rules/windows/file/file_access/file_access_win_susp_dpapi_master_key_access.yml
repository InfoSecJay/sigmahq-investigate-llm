title: Access To Windows DPAPI Master Keys By Uncommon Applications
id: 46612ae6-86be-4802-bc07-39b59feb1309
status: experimental
description: |
  Detects file access requests to the the Windows Data Protection API Master keys by an uncommon application.
  This can be a sign of credential stealing. Example case would be usage of mimikatz "dpapi::masterkey" function
references:
- http://blog.harmj0y.net/redteaming/operational-guidance-for-offensive-user-dpapi-abuse/
- https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords
author: Nasreddine Bencherchali (Nextron Systems)
date: 2022-10-17
modified: 2024-07-29
tags:
- attack.credential-access
- attack.t1555.004
logsource:
  category: file_access
  product: windows
  definition: 'Requirements: Microsoft-Windows-Kernel-File ETW provider'
detection:
  selection:
    FileName|contains:
    - '\Microsoft\Protect\S-1-5-18\'         # For System32
    - '\Microsoft\Protect\S-1-5-21-'         # For Users
  filter_system_folders:
    Image|startswith:
    - 'C:\Program Files\'
    - 'C:\Program Files (x86)\'
    - 'C:\Windows\system32\'
    - 'C:\Windows\SysWOW64\'
  condition: selection and not 1 of filter_*
falsepositives:
- Unknown
# Increase level after false positives filters are good enough
level: medium
notes: |
  ### Technical Context
  The Sigma rule "Access To Windows DPAPI Master Keys By Uncommon Applications" is designed to detect potentially malicious access to Windows Data Protection API (DPAPI) master keys by applications that are not commonly associated with this sensitive operation. The rule focuses on access attempts to the DPAPI master key files, which typically reside in the directory paths `\Microsoft\Protect\S-1-5-18\` for system processes and `\Microsoft\Protect\S-1-5-21-` for user processes. If an uncommon application attempts to access these files, it may signal credential theft attempts, such as those executed by tools like Mimikatz using the "dpapi::masterkey" function. 
  This detection relies on file access logs generated by the Microsoft-Windows-Kernel-File ETW provider, specifically focusing on the filename and comparing the accessing process's image path against a list of common directories. If the accessing application is found outside of expected paths (like `C:\Program Files\` or system folders), the alert will trigger. This activity correlates with the MITRE ATT&CK tactic of Credential Access and technique T1555.004, highlighting the need for vigilance against credential exfiltration attempts.
  ### Investigation Steps
  - **Check the EDR for Process Details:** Investigate the process details of the application that triggered the alert. Look for its origin, execution path, and authentication context to determine if it is indeed uncommon or unexpected.
    
  - **Review File Access Records:** Utilize Windows Security logs to check for access events to the DPAPI master keys. Confirm whether the accessing application used privileges that are inconsistent with regular user behavior.
  - **Analyze Network Activity:** Examine network logs via NDR for any unusual connections or data exfiltration attempts made by the same application around the time of the alert. This can provide context on potential malicious activity.
  - **Assess for Historic Activity:** Review both historical and recent alerts in the SIEM to identify any previous instances of the same uncommon application accessing sensitive files. Correlate these findings with user activities to understand possible patterns.
  ### Prioritization
  This alert is categorized as medium severity due to the potential risk of credential theft if an uncommon application successfully accesses DPAPI master keys, which could lead to broader compromise within the environment.
  ### Blind Spots and Assumptions
  The rule may not fire in scenarios where a legitimate and expected application (e.g., backup software) accesses the DPAPI files, thereby evading detection due to lack of context around the application behavior. Additionally, if the telemetry is not adequately configured or if the necessary ETW providers are disabled, the rule will not have the data required to fire. Analysts should remain cautious, as an adversary might also leverage legitimate applications to conduct such activities stealthily.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
