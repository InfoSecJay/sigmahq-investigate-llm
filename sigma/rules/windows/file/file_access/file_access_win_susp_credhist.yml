title: Access To Windows Credential History File By Uncommon Applications
id: 7a2a22ea-a203-4cd3-9abf-20eb1c5c6cd2
status: experimental
description: |
  Detects file access requests to the Windows Credential History File by an uncommon application.
  This can be a sign of credential stealing. Example case would be usage of mimikatz "dpapi::credhist" function
references:
- https://tools.thehacker.recipes/mimikatz/modules/dpapi/credhist
- https://www.passcape.com/windows_password_recovery_dpapi_credhist
author: Nasreddine Bencherchali (Nextron Systems)
date: 2022-10-17
modified: 2024-07-29
tags:
- attack.credential-access
- attack.t1555.004
logsource:
  category: file_access
  product: windows
  definition: 'Requirements: Microsoft-Windows-Kernel-File ETW provider'
detection:
  selection:
    FileName|endswith: '\Microsoft\Protect\CREDHIST'
  filter_main_system_folders:
    Image|startswith:
    - 'C:\Program Files\'
    - 'C:\Program Files (x86)\'
    - 'C:\Windows\system32\'
    - 'C:\Windows\SysWOW64\'
  filter_main_explorer:
    Image: 'C:\Windows\explorer.exe'
  condition: selection and not 1 of filter_main_*
falsepositives:
- Unknown
# Increase level after false positives filters are good enough
level: medium
notes: |
  ### Technical Context
  This Sigma rule is designed to detect unauthorized access attempts to the Windows Credential History File, typically located at `C:\Microsoft\Protect\CREDHIST`. The rule specifically looks for file access requests made by applications that are not commonly identified as legitimate processes for accessing this file. Given that adversaries often employ tools like Mimikatz to extract sensitive credentials, this rule serves as a critical alert to potential credential theft activities. The detection leverages Windows file access event logs, specifically through the Microsoft-Windows-Kernel-File ETW provider, to monitor file interactions initiated by any application outside of known system processes or Windows Explorer. This aligns with the MITRE ATT&CK tactic for Credential Access (T1555.004), indicating that the rule focuses on identifying malicious behavior that could compromise user credentials.
  ### Investigation Steps
  - **Check EDR Logs:** Investigate the file access event in the EDR platform to identify the process and user context that triggered the alert. Look for any unusual parent processes that might indicate user impersonation.
  - **Review Running Processes:** Use your systems management tool to list all currently running processes on the host where the alert was generated. Identify any unknown or unusual applications that shouldn’t be executing on the endpoint.
  - **Correlate with Network Activity:** Analyze network logs for connections made by the flagged process to determine if there was any data exfiltration attempt. Look for outbound connections to suspicious IP addresses or domains.
  - **Conduct User Activity Review:** Examine logs for the user account associated with the process to check for any suspicious login activity or anomalies in their usual behavior patterns.
  ### Prioritization
  Alerts generated by this rule are categorized as medium severity due to the potential risk of credential theft associated with uncommon applications accessing sensitive files. While not definitive proof of compromise, it warrants immediate investigation as it may indicate malicious intent.
  ### Blind spots and Assumptions
  This rule may not fire in scenarios where an adversary successfully disguises their application as a legitimate process or when the credential history file is accessed via legitimate applications that are not filtered out by the rule. Furthermore, training and visibility of the enterprise’s legitimate software landscape are essential; constant changes to approved applications could lead to false negatives. Analysts must also acknowledge that if access attempts originate solely from standard, expected applications, these actions will not trigger an alert, potentially missing a sophisticated attack vector.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
