title: Suspicious Appended Extension
id: e3f673b3-65d1-4d80-9146-466f8b63fa99
status: test
description: Detects file renames where the target filename uses an uncommon double
  extension. Could indicate potential ransomware activity renaming files and adding
  a custom extension to the encrypted files, such as ".jpg.crypted", ".docx.locky",
  etc.
references:
- https://app.any.run/tasks/d66ead5a-faf4-4437-93aa-65785afaf9e5/
- https://blog.cyble.com/2022/08/10/onyx-ransomware-renames-its-leak-site-to-vsop/
author: frack113
date: 2022-07-16
modified: 2023-11-11
tags:
- attack.impact
- attack.t1486
logsource:
  product: windows
  category: file_rename
  definition: 'Requirements: Microsoft-Windows-Kernel-File Provider with at least
    the KERNEL_FILE_KEYWORD_RENAME_SETLINK_PATH keyword'
detection:
  selection:
    SourceFilename|endswith:
    - '.doc'
    - '.docx'
    - '.jpeg'
    - '.jpg'
    - '.lnk'
    - '.pdf'
    - '.png'
    - '.pst'
    - '.rtf'
    - '.xls'
    - '.xlsx'
    TargetFilename|contains:
    - '.doc.'
    - '.docx.'
    - '.jpeg.'
    - '.jpg.'
    - '.lnk.'
    - '.pdf.'
    - '.png.'
    - '.pst.'
    - '.rtf.'
    - '.xls.'
    - '.xlsx.'
  filter_main_generic:
    TargetFilename|endswith:
            # Note: Please add more used extensions by backup or recovery software
    - '.backup'
    - '.bak'
    - '.old'
    - '.orig'
    - '.temp'
    - '.tmp'
  filter_optional_anaconda:
    TargetFilename|contains: ':\ProgramData\Anaconda3\'
    TargetFilename|endswith: '.c~'
  condition: selection and not 1 of filter_main_* and not 1 of filter_optional_*
falsepositives:
- Backup software
level: medium
notes: |
  ### Technical Context
  The "Suspicious Appended Extension" Sigma rule is designed to detect potentially malicious file renaming activities that typically accompany ransomware operations. Specifically, the rule identifies instances where a file is renamed with an uncommon double extension—such as ".jpg.crypted" or ".docx.locky"—indicating an attempt by ransomware to obscure the original file type and make it more difficult for users to recognize that a file has been encrypted. The detection leverages file rename events from the Windows Kernel File Provider, capturing details from the SourceFilename and TargetFilename to identify these anomalies.
  In terms of technical data sources, this rule relies on file rename events generated by Windows, particularly those logged under the KERNEL_FILE_KEYWORD_RENAME_SETLINK_PATH keyword. By assessing the characteristics of the source file extensions alongside the appended malicious extensions in the target, it can effectively indicate possible ransomware activities. This behavior aligns with the MITRE ATT&CK technique T1486 (Data Encrypted for Impact) as it involves the alteration of data to make it unusable.
  ### Investigation Steps
  - **Check File Rename Events**: Use Windows Security Event Logs to examine recent file rename events that match the characteristics outlined in the rule, specifically looking for files renamed with double extensions.
    
  - **Cross-reference Extensions**: Investigate the original file types and consider the context in which they were renamed. Look for files which were unexpectedly changed without a clear user action or application involvement.
  - **Endpoint Detection and Response (EDR) Analysis**: Utilize EDR tools to trace behaviors leading up to the file rename event, including any suspicious process activity or external communications that might indicate ransomware presence.
  - **Examine Backup Software Logs**: Review logs for any legitimate backup software present in the environment that may lead to similar rename patterns to rule them out as false positives.
  ### Prioritization
  The alert is classified as medium severity due to the potential risk it poses during a ransomware attack, as renaming files with suspicious double extensions usually indicates a compromise. Prompt investigation is necessary to determine if the file manipulations are part of a broader malicious campaign.
  ### Blind Spots and Assumptions
  This rule may not detect all ransomware activities if the malware uses unique or less common extensions that are not included in the rule’s list. Additionally, legitimate application behaviors, such as backup software or virus scanners that rename files with double extensions for valid reasons, can lead to false positives. Moreover, the rule relies on the availability of kernel file provider logs; if these logs are not being collected or have been tampered with, the detection may fail. Responders should remain aware of the specific configurations and operational context in which this detection rule operates to ensure its effectiveness.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
