title: OneNote Attachment File Dropped In Suspicious Location
id: 7fd164ba-126a-4d9c-9392-0d4f7c243df0
status: test
description: Detects creation of files with the ".one"/".onepkg" extension in suspicious
  or uncommon locations. This could be a sign of attackers abusing OneNote attachments
references:
- https://www.bleepingcomputer.com/news/security/hackers-now-use-microsoft-onenote-attachments-to-spread-malware/
- https://blog.osarmor.com/319/onenote-attachment-delivers-asyncrat-malware/
author: Nasreddine Bencherchali (Nextron Systems)
date: 2023-01-22
modified: 2023-09-19
tags:
- attack.defense-evasion
logsource:
  category: file_event
  product: windows
detection:
  selection:
    TargetFilename|contains:
            # Note: add more common locations for drops such as download folders and the like. Or baseline legitimate locations and alert on everything else
    - '\AppData\Local\Temp\'
    - '\Users\Public\'
    - '\Windows\Temp\'
    - ':\Temp\'
    TargetFilename|endswith:
    - '.one'
    - '.onepkg'
  filter_main_onenote:
    Image|contains: ':\Program Files\Microsoft Office\'
    Image|endswith: '\ONENOTE.EXE'
  condition: selection and not 1 of filter_main_*
falsepositives:
- Legitimate usage of ".one" or ".onepkg" files from those locations
level: medium
notes: |
  ### Technical Context
  This Sigma rule is designed to detect the malicious use of Microsoft OneNote attachments by monitoring the creation of files with the ".one" and ".onepkg" extensions in suspicious or uncommon locations on Windows systems. The rule specifically looks for these file types being created in directories typically associated with temporary files or shared resources, such as the `AppData\Local\Temp\`, `Users\Public\`, and `Windows\Temp\` directories. These locations are not standard for legitimate OneNote files, which indicates potential misuse.
  The detection leverages file event logs generated by Windows, particularly focusing on the target filename's path and extension. The rule also includes filtering criteria to ensure that such file creations are not part of normal operations by verifying that the file creation process is initiated by OneNote itself (i.e., checking if the image path ends with `\ONENOTE.EXE`). This aligns with the MITRE ATT&CK tactic of Defense Evasion (specifically, technique T1203, "Exploitation for Client Execution"), indicating that attackers may leverage OneNote attachments to evade traditional detection methods while distributing malware.
  ### Investigation Steps
  - **Review Event Logs:** Examine Windows Security and Sysmon logs for process creation events related to OneNote around the time of the alert to identify any suspicious activity leading to the file creation.
  - **Check EDR for Related Artifacts:** Utilize Endpoint Detection and Response (EDR) tools to analyze the suspicious .one or .onepkg files and their related processes for known malware signatures or behaviors.
  - **Investigate File Origin:** Analyze the network connection logs to trace the download source of the OneNote files, which could help identify the potential command and control (C2) infrastructure used by the attackers.
  - **Cross-reference User Activity:** Look into Proxy and VPN logs to determine if the affected user exhibited any unusual behavior, such as accessing external sites or services that are not part of their normal activity.
  ### Prioritization
  The alert is categorized as medium severity due to the potential risk posed by malicious OneNote files, which may indicate an attempt to deliver malware or conduct further exploitation against the enterprise environment.
  ### Blind Spots and Assumptions
  This rule may not fire if attackers use standard or known locations for file creation, evading detection by following legitimate paths for OneNote. Additionally, the rule assumes that the running processes are not spoofed or that the EDR is configured to monitor all relevant locations effectively. It may also miss legitimate file usage scenarios, such as internal training materials or shared files from team members, leading to false positives if not carefully filtered.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
