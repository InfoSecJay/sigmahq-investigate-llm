title: HackTool - Typical HiveNightmare SAM File Export
id: 6ea858a8-ba71-4a12-b2cc-5d83312404c7
status: test
description: Detects files written by the different tools that exploit HiveNightmare
references:
- https://github.com/GossiTheDog/HiveNightmare
- https://github.com/FireFart/hivenightmare/
- https://github.com/WiredPulse/Invoke-HiveNightmare
- https://twitter.com/cube0x0/status/1418920190759378944
author: Florian Roth (Nextron Systems)
date: 2021-07-23
modified: 2024-06-27
tags:
- attack.credential-access
- attack.t1552.001
- cve.2021-36934
logsource:
  product: windows
  category: file_event
detection:
  selection:
  - TargetFilename|contains:
    - '\hive_sam_'            # Go version
    - '\SAM-2021-'            # C++ version
    - '\SAM-2022-'            # C++ version
    - '\SAM-2023-'            # C++ version
    - '\SAM-haxx'             # Early C++ versions
    - '\Sam.save'             # PowerShell version
  - TargetFilename: 'C:\windows\temp\sam'        # C# version of HiveNightmare
  condition: selection
falsepositives:
- Files that accidentally contain these strings
level: high
notes: |
  ### Technical Context
  The Sigma rule titled "HackTool 
  - Typical HiveNightmare SAM File Export" is designed to detect unauthorized attempts to extract sensitive information from the Security Account Manager (SAM) in Windows systems using various tools that exploit vulnerabilities, notably the HiveNightmare technique. The detection mechanism focuses on log data generated by file events, specifically targeting filenames that are indicative of SAM file exports associated with HiveNightmare, including variations from different programming implementations (Go, C++, PowerShell). When these specific filenames are detected, it suggests that a tool has been used to access and potentially exfiltrate sensitive credential information stored in the SAM database. This action is associated with the MITRE ATT&CK tactic of Credential Access and the technique T1552.001 (Application Layer Protocol: credentials in files).
  To track these potentially malicious events, the rule relies primarily on Windows file event logs, monitoring for file creations that match the specified target filename patterns. By correlating these patterns with real-time data sources in the enterprise, the SOC can identify abnormal activities and assess whether these exports represent malicious behavior.
  ### Investigation Steps
  - **Review File Event Logs:** Investigate the Windows file event logs to identify the instances where the targeted SAM files were written to disk, noting the timestamps and user accounts involved.
    
  - **Analyze User Behavior:** Use EDR to analyze the behavior of the user account that triggered the alert. Assess whether the user has legitimate reasons for accessing SAM files or if there are signs of compromise.
  - **Correlate with Process Creation Logs:** Check for process creation logs that coincide with the detected file events, focusing on processes that may have invoked HiveNightmare tools or similar utilities.
  - **Threat Intelligence Lookup:** Conduct a lookup on the identified tools in threat intelligence platforms to understand their common usage patterns and associated threat actors, aiding in determining the threat's severity.
  ### Prioritization
  This alert is categorized as high severity due to the sensitivity of the data being targetedâ€”the SAM database contains critical authentication credentials. Unauthorized access to or exports of this data can pose significant security risks, including account compromise and unauthorized access to systems.
  ### Blind Spots and Assumptions
  This rule may not fire in environments where logging is not configured to capture file creation events, or where users have legitimate reasons to use tools that generate similar filenames. There is an assumption that all file write operations are correctly logged, which may not be the case with certain configurations or log management issues. Additionally, an adversary might alter the filenames or use stealthier methods to extract the SAM files, bypassing this detection entirely. Understanding these limitations is crucial for enhancing the rule's effectiveness and investigating alerts thoroughly.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
