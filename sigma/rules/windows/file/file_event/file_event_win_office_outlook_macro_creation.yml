title: New Outlook Macro Created
id: 8c31f563-f9a7-450c-bfa8-35f8f32f1f61
related:
- id: 117d3d3a-755c-4a61-b23e-9171146d094c
  type: derived
status: test
description: Detects the creation of a macro file for Outlook.
references:
- https://www.mdsec.co.uk/2020/11/a-fresh-outlook-on-mail-based-persistence/
author: '@ScoubiMtl'
date: 2021-04-05
modified: 2023-02-08
tags:
- attack.persistence
- attack.command-and-control
- attack.t1137
- attack.t1008
- attack.t1546
logsource:
  category: file_event
  product: windows
detection:
  selection:
    Image|endswith: '\outlook.exe'
    TargetFilename|endswith: '\Microsoft\Outlook\VbaProject.OTM'
  condition: selection
falsepositives:
- User genuinely creates a VB Macro for their email
level: medium
notes: |
  ### Technical Context
  This detection rule aims to identify the unauthorized creation of macro files within Microsoft Outlook, specifically targeting the `VbaProject.OTM` file. Macros can be used by threat actors to establish malicious persistence mechanisms or facilitate command-and-control (C2) communications, thus posing a risk to enterprise security. The rule monitors file events generated by Windows, focusing on instances where the macro file is created while Outlook is the running application. By leveraging file event logs, particularly those that detail file creation activities, the detection rule helps analysts uncover deceptive practices that may indicate malicious intent in the environment. This aligns with the MITRE ATT&CK techniques T1137 (Office Application Startup), T1008 (Command and Control Over Alternative Port), and T1546 (Event Triggered Execution).
  ### Investigation Steps
  - **Review File Creation Events:** Use the EDR tool to search for file creation logs around the time the alert was triggered. Check for additional indicators related to the `VbaProject.OTM` file and its associated Outlook processes.
    
  - **Analyze Related User Activity:** Investigate the user's recent activity using Windows Security logs to determine if the macro creation was a legitimate user action. Look for patterns in user behavior that may indicate compromise.
    
  - **Inspect Outlook Process:** Utilize Sysmon process creation logs to track the behavior of `outlook.exe` before and after the macro's creation. Verify if any unusual command-line arguments or unexpected parent-child process relationships exist.
    
  - **Assess Networking Connections:** Review network logs to identify any unusual outbound connections made by Outlook directly after the macro was created. Assess whether these connections align with known C2 traffic patterns.
  ### Prioritization
  The alert is rated as medium severity due to the potential for malicious use of macro functionality in Outlook, which may signify an attempt to establish persistent access or unauthorized data exfiltration within the enterprise environment.
  ### Blind Spots and Assumptions
  This rule may generate false positives if users genuinely create VB Macros for legitimate tasks within Outlook. Additionally, the detection may not fire if the macro is created through an alternative method outside the monitored file creation events, such as direct file manipulation or through another application interfacing with Outlook. It is assumed that all necessary telemetry is being collected reliably and that the environment is adequately monitored for process activity and network anomalies.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
