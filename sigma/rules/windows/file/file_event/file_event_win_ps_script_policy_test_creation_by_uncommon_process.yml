title: PSScriptPolicyTest Creation By Uncommon Process
id: 1027d292-dd87-4a1a-8701-2abe04d7783c
status: test
description: Detects the creation of the "PSScriptPolicyTest" PowerShell script by
  an uncommon process. This file is usually generated by Microsoft Powershell to test
  against Applocker.
references:
- https://www.paloaltonetworks.com/blog/security-operations/stopping-powershell-without-powershell/
author: Nasreddine Bencherchali (Nextron Systems)
date: 2023-06-01
modified: 2023-12-11
tags:
- attack.defense-evasion
logsource:
  product: windows
  category: file_event
detection:
  selection:
    TargetFilename|contains: '__PSScriptPolicyTest_'
  filter_main_generic:
    Image|endswith:
    - ':\Program Files\PowerShell\7-preview\pwsh.exe'
    - ':\Program Files\PowerShell\7\pwsh.exe'
    - ':\Windows\System32\dsac.exe'
    - ':\Windows\System32\sdiagnhost.exe'
    - ':\Windows\System32\ServerManager.exe'
    - ':\Windows\System32\WindowsPowerShell\v1.0\powershell_ise.exe'
    - ':\Windows\System32\WindowsPowerShell\v1.0\powershell.exe'
    - ':\Windows\System32\wsmprovhost.exe'
    - ':\Windows\SysWOW64\sdiagnhost.exe'
    - ':\Windows\SysWOW64\WindowsPowerShell\v1.0\powershell_ise.exe'
    - ':\Windows\SysWOW64\WindowsPowerShell\v1.0\powershell.exe'
  condition: selection and not 1 of filter_main_*
falsepositives:
- Unknown
level: medium
notes: |
  n
  ### Technical Context
  The Sigma rule titled "PSScriptPolicyTest Creation By Uncommon Process" is designed to detect the creation of a PowerShell script named "PSScriptPolicyTest," which is often created by Microsoft PowerShell for testing against application control policies like AppLocker. The detection logic focuses on specific file events where the filename contains the substring '__PSScriptPolicyTest_' and where the creation event originates from uncommon processes, specifically those that are not standard PowerShell executables. The rule operates by analyzing Windows file event logs to identify any irregular instances where this script is generated, potentially indicating an attempt to evade application controls or exploit vulnerabilities. This rule aligns with the MITRE ATT&CK tactic of "Defense Evasion" (T1203), highlighting the importance of monitoring process behavior to detect malicious actions disguised within legitimate activities.
  ### Investigation Steps
  - **Check EDR Alerts:** Investigate the endpoint where the alert was triggered by reviewing EDR logs for any recent process creation events leading up to the detection of the PSScriptPolicyTest script.
  - **Review Process Tree:** Utilize the EDR to analyze the process tree and identify the parent processes associated with creating the PSScriptPolicyTest script to uncover potential malicious behavior.
  - **Analyze File Activity:** Examine file event logs for additional context regarding file access to the PSScriptPolicyTest script, including modifications, access timestamps, and any other interactions with the file.
  - **Correlate with Network Logs:** Inspect relevant network logs from NDR and proxy solutions to detect any suspicious outbound requests or connections made by the uncommon process that created the script.
  ### Prioritization
  This alert is considered medium severity due to its association with potentially malicious activities aimed at bypassing security measures, which can lead to further exploitation of the environment if not addressed promptly.
  ### Blind Spots and Assumptions
  The detection rule might not trigger if the script is created by a commonly used and trusted process that falls outside the specified uncommon processes. Additionally, if an effective evasion technique is employed, such as altering the file name or creating the script under alternative contexts, the alert may not activate. It is assumed that endpoint protection mechanisms are enabled; otherwise, malicious behavior could proceed undetected.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
