title: NTDS.DIT Creation By Uncommon Process
id: 11b1ed55-154d-4e82-8ad7-83739298f720
related:
- id: 4e7050dd-e548-483f-b7d6-527ab4fa784d
  type: similar
status: test
description: Detects creation of a file named "ntds.dit" (Active Directory Database)
  by an uncommon process or a process located in a suspicious directory
references:
- https://stealthbits.com/blog/extracting-password-hashes-from-the-ntds-dit-file/
- https://adsecurity.org/?p=2398
author: Florian Roth (Nextron Systems), Nasreddine Bencherchali (Nextron Systems)
date: 2022-01-11
modified: 2022-07-14
tags:
- attack.credential-access
- attack.t1003.002
- attack.t1003.003
logsource:
  product: windows
  category: file_event
detection:
  selection_ntds:
    TargetFilename|endswith: '\ntds.dit'
  selection_process_img:
    Image|endswith:
            # Add more suspicious processes as you see fit
    - '\cmd.exe'
    - '\cscript.exe'
    - '\mshta.exe'
    - '\powershell.exe'
    - '\pwsh.exe'
    - '\regsvr32.exe'
    - '\rundll32.exe'
    - '\wscript.exe'
    - '\wsl.exe'
    - '\wt.exe'
  selection_process_paths:
    Image|contains:
    - '\AppData\'
    - '\Temp\'
    - '\Public\'
    - '\PerfLogs\'
  condition: selection_ntds and 1 of selection_process_*
falsepositives:
- Unknown
level: high
notes: |
  ### Technical Context
  This Sigma rule is designed to detect unauthorized or suspicious attempts to create the NTDS.DIT file, which is the Active Directory database file crucial for storing user credentials and account information. The detection mechanism focuses on identifying attempts that originate from uncommon or suspicious processes, such as `cmd.exe`, `powershell.exe`, or `wscript.exe`, especially when these processes operate from atypical directories, including user directories like `AppData` or `Temp`. By monitoring file creation events, this rule checks whether a process responsible for triggering the creation of the NTDS.DIT file matches the defined suspicious criteria.
  This rule is closely aligned with the MITRE ATT&CK tactic of Credential Access and includes techniques T1003.002 (Credential Dumping: NTDS) and T1003.003 (Credential Dumping: DCOM). These techniques highlight the risk of credential theft that may arise from unauthorized access to the NTDS.DIT file, making it critical for SOC analysts to quickly identify and mitigate any alerts generated by this rule.
  ### Investigation Steps
  - **Verify File Creation**: Check file event logs in the SIEM to confirm the creation of `ntds.dit` and note the timestamp and source process that initiated the file creation.
  - **Analyze Process Details**: Use your EDR tool to investigate the process that triggered the alert, focusing on its parent process, command-line arguments, and integrity level to determine its legitimacy.
  - **Examine Process Path**: Cross-reference the process's image path against the suspicious directories listed in the rule. Identify whether it originated from a common or uncommon location, which may indicate potential risk.
  - **Collect Contextual Information**: Review additional relevant logs (e.g., Windows Security, System, and Application logs) to gather contextual information about user behavior around the time of the event, including login attempts or other suspicious activity.
  ### Prioritization
  The alert generated by this rule is classified as high severity due to the critical nature of the NTDS.DIT file. Unauthorized access or creation of this file poses a significant threat to enterprise security, as it may indicate an active credential dumping effort that could lead to further compromise of user accounts and systems.
  ### Blind Spots and Assumptions
  This rule may not fire under certain conditions, such as if the suspicious process is executed with elevated privileges or if the file creation occurs as part of a legitimate administrative task not covered by the specific processes monitored. Additionally, the rule assumes that the requisite log sources are being captured and that appropriate logging policies are in place. Adversaries may also employ tactics to obfuscate the true nature of their activities, using processes not listed in the defined suspicious group, or by targeting the NTDS.DIT file indirectly.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
