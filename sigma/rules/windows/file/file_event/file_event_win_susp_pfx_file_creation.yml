title: Suspicious PFX File Creation
id: dca1b3e8-e043-4ec8-85d7-867f334b5724
status: test
description: A general detection for processes creating PFX files. This could be an
  indicator of an adversary exporting a local certificate to a PFX file.
references:
- https://github.com/OTRF/detection-hackathon-apt29/issues/14
- https://github.com/OTRF/ThreatHunter-Playbook/blob/2d4257f630f4c9770f78d0c1df059f891ffc3fec/docs/evals/apt29/detections/6.B.1_6392C9F1-D975-4F75-8A70-433DEDD7F622.md
author: Roberto Rodriguez (Cyb3rWard0g), OTR (Open Threat Research)
date: 2020-05-02
modified: 2022-07-07
tags:
- attack.credential-access
- attack.t1552.004
logsource:
  product: windows
  category: file_event
detection:
  selection:
    TargetFilename|endswith: '.pfx'
  filter_main_windows_tmp_key:
    TargetFilename|contains|all:
    - '\Templates\Windows\Windows_TemporaryKey.pfx'
    - '\CMake\'
  condition: selection and not 1 of filter_main_*
falsepositives:
- System administrators managing certificates.
level: medium
notes: |
  ### Technical Context
  The detection rule titled "Suspicious PFX File Creation" aims to identify instances where a process creates PFX files on Windows systems, which can be indicative of malicious activities such as an adversary exporting a local certificate to a PFX file for unauthorized access or other malicious purposes. The rule focuses on monitoring file creation events where the TargetFilename ends with '.pfx'. To enhance the reliability of the alert, it also includes a filter that excludes instances where the filename contains paths associated with legitimate administrative tasks, specifically those involving temporary keys or development environments (i.e., paths containing `\Templates\Windows\Windows_TemporaryKey.pfx` and `\CMake\`). The relevant technical data sources include Windows file event logs that will provide insights into file creation actions on the system. This detection aligns with the MITRE ATT&CK framework under the tactics of credential access (TA-0021) and the technique of credential dumping (T1552.004).
  ### Investigation Steps
  - **Review File Event Logs**: Examine Windows file event logs to identify all instances of PFX file creation, focusing on the username and process associated with each event.
  - **Correlate with Process Execution**: Use EDR tools to correlate the file creation with process execution logs, identifying any suspicious scripts or executables that triggered the file creation.
  - **Analyze User Activities**: Check user actions around the time the PFX file was created to determine if there were any unauthorized activities or anomalies in legitimate administrative functions.
  - **Inspect Network Behavior**: Assess network logs to see if the potentially malicious PFX file was used in any outbound connections, particularly to external servers or known malicious IP addresses.
  ### Prioritization
  The alert generated by this detection rule is prioritized as medium severity due to the potential risk it represents in the context of credential access. While not all PFX file creations are indicative of nefarious activity, such files can be weaponized by adversaries to gain unauthorized access to sensitive information, necessitating timely investigation.
  ### Blind Spots and Assumptions
  One significant blind spot for this detection rule is the possibility of false positives generated by legitimate actions performed by system administrators who manage certificates. Additionally, adversaries may use steganography or other techniques to mask suspicious file activities, resulting in the rule not firing. Furthermore, if the creation of the PFX file occurs outside monitored directories or with modifications to file extensions or paths, it could evade detection. 
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
