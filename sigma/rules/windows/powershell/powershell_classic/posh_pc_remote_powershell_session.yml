title: Remote PowerShell Session (PS Classic)
id: 60167e5c-84b2-4c95-a7ac-86281f27c445
related:
- id: 96b9f619-aa91-478f-bacb-c3e50f8df575
  type: derived
status: test
description: Detects remote PowerShell sessions
references:
- https://threathunterplaybook.com/hunts/windows/190511-RemotePwshExecution/notebook.html
author: Roberto Rodriguez @Cyb3rWard0g
date: 2019-08-10
modified: 2024-01-03
tags:
- attack.execution
- attack.t1059.001
- attack.lateral-movement
- attack.t1021.006
logsource:
  product: windows
  category: ps_classic_start
detection:
  selection:
    Data|contains|all:
    - 'HostName=ServerRemoteHost'
    - 'wsmprovhost.exe'
  condition: selection
falsepositives:
- Legitimate use remote PowerShell sessions
# Note: Increase the level to "medium" in environments that do not leverage PowerShell remoting
level: low
notes: |
  ### Technical Context
  This detection rule identifies instances of remote PowerShell sessions initiated with the `wsmprovhost.exe` process, a Windows Management Instrumentation (WMI) provider host. The rule focuses on log data generated by Windows PowerShell, specifically monitoring for the presence of certain keywords indicating a remote session. By looking for the data entries that include 'HostName=ServerRemoteHost' and the execution of `wsmprovhost.exe`, the rule can detect potentially unauthorized lateral movement within a network, where an adversary may attempt to execute commands or scripts on remote systems to gain access or persist within the environment. The rule corresponds to the MITRE ATT&CK techniques, especially T1059.001 (PowerShell) and T1021.006 (Remote Services).
  ### Investigation Steps
  - **Check EDR Logs:** Review the endpoint detection and response logs for any indicators associated with the execution of `wsmprovhost.exe`, especially looking for unusual patterns or unauthorized remote sessions.
    
  - **Analyze Windows Event Logs:** Inspect the Security and System event logs for logon attempts and process creation events around the same time as the alert to determine whether there were legitimate or malicious access attempts.
  - **Review Network Connections:** Utilize network detection and response tools to examine any outbound connections that were established during the time of the alert, focusing on connections to unfamiliar or unauthorized IP addresses.
  - **Audit PowerShell Activity:** Investigate the PowerShell command history and logs on the affected system for unusual commands or scripts that correspond to the timing of the detected remote session.
  ### Prioritization
  This alert is categorized as low severity, as it may stem from legitimate administrative tasks if remote PowerShell usage is authorized in the environment. However, it is essential to evaluate the context and ensure appropriate logging and auditing of such sessions, especially in environments that do not commonly utilize PowerShell remoting.
  ### Blind Spots and Assumptions
  This detection rule makes several assumptions: it presumes that legitimate remote PowerShell sessions are infrequent, and any instance of `wsmprovhost.exe` running with the specific hostname could indicate potential misuse. Additionally, in environments where remote PowerShell is standard practice, the rule may generate false positives. Furthermore, the detection may fail to trigger if attackers employ obfuscation techniques, alter process names, or use methods outside the identified parametersâ€”thus emphasizing the need for comprehensive monitoring beyond this specific rule.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
