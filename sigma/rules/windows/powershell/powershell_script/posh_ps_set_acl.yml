title: PowerShell Script Change Permission Via Set-Acl - PsScript
id: cae80281-ef23-44c5-873b-fd48d2666f49
related:
- id: 0944e002-e3f6-4eb5-bf69-3a3067b53d73     # ProcCreation Susp
  type: derived
- id: bdeb2cff-af74-4094-8426-724dc937f20a     # ProcCreation Low
  type: derived
- id: 3bf1d859-3a7e-44cb-8809-a99e066d3478     # PsScript High
  type: derived
status: test
description: Detects PowerShell scripts set ACL to of a file or a folder
references:
- https://github.com/redcanaryco/atomic-red-team/blob/74438b0237d141ee9c99747976447dc884cb1a39/atomics/T1505.005/T1505.005.md
author: frack113, Nasreddine Bencherchali (Nextron Systems)
date: 2023-07-18
tags:
- attack.defense-evasion
- attack.t1222
logsource:
  product: windows
  category: ps_script
  definition: bade5735-5ab0-4aa7-a642-a11be0e40872
detection:
  selection:
    ScriptBlockText|contains|all:
    - 'Set-Acl '
    - '-AclObject '
    - '-Path '
  condition: selection
falsepositives:
- Unknown
level: low
notes: |
  n
  ### Technical Context
  The PowerShell detection rule titled "PowerShell Script Change Permission Via Set-Acl 
  - PsScript" is designed to identify potentially malicious use of the `Set-Acl` cmdlet within PowerShell scripts. This cmdlet is typically used to modify the Access Control List (ACL) of files or folders within a Windows environment, which can be indicative of attempts to evade security controls or manipulate access rights maliciously. The rule specifically looks for script block text that includes the terms 'Set-Acl', '-AclObject', and '-Path', which are commonly associated with permission manipulation. The primary data sources for this detection are PowerShell script execution logs generated by Sysmon, which provides detailed information about command execution and script blocks. This detection aligns with the MITRE ATT&CK technique T1222, which focuses on bypassing defenses through modification of permissions.
  ### Investigation Steps
  - **Review PowerShell Execution Logs:** Examine the relevant PowerShell execution logs in Sysmon to identify the specific script or commands that triggered the alert. Pay attention to the context in which the `Set-Acl` command was executed.
  - **Correlate with Process Creation Events:** Utilize EDR tools to correlate the PowerShell execution with any process creation events to check for suspicious parent-child process relationships. This will help contextualize the PowerShell activity within the broader environment.
  - **Check for Other Anomalous Activity:** Review other relevant logs, such as file access logs or network activity, around the same timeframe to observe any unusual behavior that may indicate a larger security incident.
  - **Investigate System Permissions:** Use Windows Security and System Event logs to monitor changes in user permissions associated with the modified files or directories. This can help determine if the permission changes were legitimate or part of a malicious effort.
  ### Prioritization
  Given the potential for misuse of the `Set-Acl` command to alter permissions and compromise sensitive data, this alert is considered low priority. However, analysts should remain vigilant, as it can indicate initial stages of a more significant attack vector.
  ### Blind Spots and Assumptions
  This detection may not fire if the script containing the `Set-Acl` command is obfuscated or executed in a manner that circumvents standard logging practices. Additionally, legitimate administrative activities may occasionally trigger this rule, leading to false positives. It is vital for detection engineers to understand that well-concealed adversaries may employ various tactics to mask such activities, thus limiting the effectiveness of simple string matching in PowerShell logs.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
