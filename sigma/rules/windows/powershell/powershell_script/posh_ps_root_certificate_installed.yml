title: Root Certificate Installed - PowerShell
id: 42821614-9264-4761-acfc-5772c3286f76
status: test
description: Adversaries may install a root certificate on a compromised system to
  avoid warnings when connecting to adversary controlled web servers.
references:
- https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1553.004/T1553.004.md
author: 'oscd.community, @redcanary, Zach Stanford @svch0st'
date: 2020-10-10
modified: 2022-12-02
tags:
- attack.defense-evasion
- attack.t1553.004
logsource:
  product: windows
  category: ps_script
  definition: 'Requirements: Script Block Logging must be enabled'
detection:
  selection1:
    ScriptBlockText|contains|all:
    - 'Move-Item'
    - 'Cert:\LocalMachine\Root'
  selection2:
    ScriptBlockText|contains|all:
    - 'Import-Certificate'
    - 'Cert:\LocalMachine\Root'
  condition: 1 of selection*
falsepositives:
- Help Desk or IT may need to manually add a corporate Root CA on occasion. Need to
  test if GPO push doesn't trigger FP
level: medium
notes: |
  ### Technical Context
  This Sigma rule detects potential malicious activity related to the installation of a root certificate on Windows systems using PowerShell. Adversaries may exploit this technique to ensure trusted connections to their controlled servers, circumventing security warnings that would ordinarily alert users to potential risks. The rule focuses on monitoring PowerShell script block logging, particularly targeting the commands `Move-Item` and `Import-Certificate`, which are indicative of attempts to manipulate the certificate store for the Local Machine Root. In order for this rule to be effective, Script Block Logging must be enabled on the target systems. This detection maps to the MITRE ATT&CK tactic of Defense Evasion, specifically under the technique T1553.004, "Root Certificate".
  ### Investigation Steps
  - **Review PowerShell Logs:** Analyze PowerShell logs within Windows Event Log to retrieve details about the execution context, including the user account running the script and the full command-line parameters used during the execution.
  - **Check EDR Alerts:** Utilize the EDR platform to search for any entries related to the execution of the PowerShell commands identified in this rule, particularly focusing on any related process creations or memory manipulations.
  - **Inspect Certificate Store:** Examine the Local Machine certificate store (`Cert:\LocalMachine\Root`) for any recently added or modified certificates that correspond to suspicious activity or unrecognized publishers.
  - **Network Traffic Analysis:** Investigate any outbound network connections made shortly after the execution of the script, looking for communications to known malicious domains or IP addresses that might indicate further compromise.
  ### Prioritization
  The alert generated by this rule is categorized as medium severity given that the installation of a root certificate can lead to significant security risks, as it enables an adversary to perform man-in-the-middle attacks while avoiding detection. Immediate investigation is necessary to mitigate potential harm to sensitive data and systems.
  ### Blind Spots and Assumptions
  This rule assumes that Script Block Logging is always enabled on target systems, which may not be the case in all environments due to policy restrictions or oversight. Additionally, legitimate administrative actions, such as corporate help desk activities or Group Policy Object (GPO) deployments of root certificates, may trigger false positives. Adversaries may also employ obfuscation techniques or run commands outside of PowerShell, bypassing detection by this rule. Engineers should consider these factors when analyzing the effectiveness of the rule and understanding its limitations.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
