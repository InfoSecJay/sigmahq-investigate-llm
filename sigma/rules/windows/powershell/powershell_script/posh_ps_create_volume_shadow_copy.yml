title: Create Volume Shadow Copy with Powershell
id: afd12fed-b0ec-45c9-a13d-aa86625dac81
status: test
description: Adversaries may attempt to access or create a copy of the Active Directory
  domain database in order to steal credential information
references:
- https://attack.mitre.org/datasources/DS0005/
- https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-wmiobject?view=powershell-5.1&viewFallbackFrom=powershell-7
author: frack113
date: 2022-01-12
tags:
- attack.credential-access
- attack.t1003.003
logsource:
  product: windows
  category: ps_script
  definition: 'Requirements: Script Block Logging must be enabled'
detection:
  selection:
    ScriptBlockText|contains|all:
    - Win32_ShadowCopy
    - ').Create('
    - ClientAccessible
  condition: selection
falsepositives:
- Legitimate PowerShell scripts
level: high
notes: |
  ### Technical Context
  The "Create Volume Shadow Copy with Powershell" detection rule seeks to identify suspicious attempts by adversaries to manipulate Windows Volume Shadow Copy Service (VSS) through PowerShell scripts. This technique is often employed to create backup copies of system states, including Active Directory (AD) databases, enabling attackers to potentially extract credential information or other sensitive data. The rule specifically monitors for common PowerShell script patterns and commands, such as calls to the `Win32_ShadowCopy` class, which is cross-referenced with particular method invocations like `Create`. By leveraging logs generated by PowerShell scripts, this detection can provide insight into automated or manual processes that may not align with normal operational behavior.
  The rule falls under the MITRE ATT&CK tactic of Credential Access, specifically technique T1003.003 (Credential Dumping: Windows Shadow Copy). To function effectively, this rule requires that Script Block Logging is enabled on Windows systems, which allows for capturing detailed PowerShell execution data. Key data sources involved include PowerShell script logs and Sysmon events, particularly those related to script execution and process creation.
  ### Investigation Steps
  - **Investigate PowerShell Logs:** Review PowerShell logs in the Security event log or Sysmon logs for the execution of suspicious PowerShell commands related to Shadow Copy creation, especially looking for the presence of `Win32_ShadowCopy` and the `Create` method.
  - **Analyze Process Trees:** Utilize EDR tools to inspect the process tree related to the execution of the PowerShell script to determine parent-child relationships that might indicate malicious behaviors.
  - **Cross-Reference with User Behavior:** Check the user account associated with the PowerShell script execution to ensure that it aligns with typical usage patterns. Look for any anomalies in login times or geographical locations.
  - **Examine AD Logs:** Consult Active Directory logs and system event logs to identify any unusual activity, such as attempts to access or modify sensitive directories related to AD or VSS, correlated with the time of the alert.
  ### Prioritization
  This alert is marked as high severity due to the potential implications of adversaries gaining access to credential information from Active Directory. Shadow Copy manipulations can enable attackers to extract sensitive information offline, increasing the risk of lateral movement within the environment.
  ### Blind spots and Assumptions
  - This detection may not trigger if Script Block Logging is disabled, resulting in no recorded PowerShell activities that utilize the targeted commands.
  - Legitimate administrative tasks might be falsely flagged, leading to potential noise in alerts. Assumptions about normal user behavior could also result in missed detections if user patterns change or if administrative accounts are compromised.
  - Adversaries may employ obfuscation techniques or execute PowerShell scripts from other contexts that do not match this detection framework, such as executing via alternative shells that do not log in the same manner.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
