title: Potentially Suspicious Malware Callback Communication
id: 4b89abaa-99fe-4232-afdd-8f9aa4d20382
related:
- id: 6d8c3d20-a5e1-494f-8412-4571d716cf5c
  type: similar
status: test
description: |
  Detects programs that connect to known malware callback ports based on statistical analysis from two different sandbox system databases
references:
- https://docs.google.com/spreadsheets/d/17pSTDNpa0sf6pHeRhusvWG6rThciE8CsXTSlDUAZDyo
author: Florian Roth (Nextron Systems)
date: 2017-03-19
modified: 2024-03-12
tags:
- attack.persistence
- attack.command-and-control
- attack.t1571
logsource:
  category: network_connection
  product: windows
detection:
  selection:
    Initiated: 'true'
    DestinationPort:
    - 100
    - 198
    - 200
    - 243
    - 473
    - 666
    - 700
    - 743
    - 777
    - 1443
    - 1515
    - 1777
    - 1817
    - 1904
    - 1960
    - 2443
    - 2448
    - 3360
    - 3675
    - 3939
    - 4040
    - 4433
    - 4438
    - 4443
    - 4444
    - 4455
    - 5445
    - 5552
    - 5649
    - 6625
    - 7210
    - 7777
    - 8143
    - 8843
    - 9631
    - 9943
    - 10101
    - 12102
    - 12103
    - 12322
    - 13145
    - 13394
    - 13504
    - 13505
    - 13506
    - 13507
    - 14102
    - 14103
    - 14154
    - 49180
    - 65520
    - 65535
  filter_main_local_ranges:
    DestinationIp|cidr:
    - '127.0.0.0/8'
    - '10.0.0.0/8'
    - '172.16.0.0/12'
    - '192.168.0.0/16'
    - '169.254.0.0/16'
    - '::1/128'          # IPv6 loopback
    - 'fe80::/10'          # IPv6 link-local addresses
    - 'fc00::/7'          # IPv6 private addresses
  filter_optional_sys_directories:
    Image|startswith:
    - 'C:\Program Files\'
    - 'C:\Program Files (x86)\'
  condition: selection and not 1 of filter_main_* and not 1 of filter_optional_*
falsepositives:
- Unknown
level: high
notes: |
  ### Technical Context
  The rule titled "Potentially Suspicious Malware Callback Communication" is designed to detect attempts by programs to connect to known malware callback ports. These ports are identified through statistical analysis gleaned from sandbox systems, which have documented common usage by malicious software for command-and-control (C2) communications. The detection mechanism primarily focuses on network connection logs where the connection is initiated (`Initiated: 'true'`), and the destination port matches a predefined set of suspicious port numbers. The rule specifically filters out local network traffic, including private and loopback addresses, which reduces the likelihood of false positives from benign internal traffic or applications.
  This rule relates to the MITRE ATT&CK framework tactic of persistence (T1071 â€“ Application Layer Protocol) and command-and-control (C2) behavior, whereby threat actors seek to maintain control over compromised systems and communicate with them using covert protocols. By monitoring external network connections to these suspect ports, security operations teams can identify potential malicious activities and initiate further investigation.
  ### Investigation Steps
  - **Review Network Logs**: Examine network connection logs in the SIEM or EDR for any entries that match the criteria set by the detection rule. Focus on the specific destination ports noted in the alert.
    
  - **Correlate with Endpoint Behavior**: Use EDR solutions to correlate the alerts with endpoint activity, looking for unusual processes that spawned the network connection. Check for any anomalies in process creation, command-line parameters, or associated user accounts.
  - **Analyze Traffic Patterns**: Leverage NDR or network monitoring tools to analyze traffic patterns around the alert timeframe. Assess whether the unusual network activity corresponds with known legitimate traffic for business operations.
  - **Investigate Historical Context**: Look for previous alerts associated with the same source or destination IP addresses to determine if this is a one-time occurrence or part of a larger trend or ongoing malicious activity.
  ### Prioritization
  Given that the alert is classified as high severity, it signifies an urgent need for investigation due to the potential link to command-and-control infrastructure commonly associated with malware activity. In an enterprise environment, such alerts should be prioritized for immediate triage to prevent potential data breaches or system compromises.
  ### Blind Spots and Assumptions
  The rule assumes that the targeted malicious programs will attempt to connect to predefined ports listed. However, it may not fire if attackers utilize non-standard ports, use encrypted communication, or employ techniques such as domain generation algorithms to mask their traffic. Additionally, legitimate applications that might connect to these ports can lead to false positives, while traffic from whitelisted applications may be inadvertently excluded. Analysts should remain vigilant for updates in threat intelligence that may inform changes to the list of ports or update alerting mechanisms accordingly.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
