title: PUA - CSExec Default Named Pipe
id: f318b911-ea88-43f4-9281-0de23ede628e
related:
- id: 9e77ed63-2ecf-4c7b-b09d-640834882028
  type: obsolete
status: test
description: Detects default CSExec pipe creation
references:
- https://drive.google.com/file/d/1lKya3_mLnR3UQuCoiYruO3qgu052_iS_/view
- https://github.com/malcomvetter/CSExec
author: Nikita Nazarov, oscd.community, Nasreddine Bencherchali (Nextron Systems)
date: 2023-08-07
modified: 2023-11-30
tags:
- attack.lateral-movement
- attack.t1021.002
- attack.execution
- attack.t1569.002
logsource:
  product: windows
  category: pipe_created
  definition: 'Note that you have to configure logging for Named Pipe Events in Sysmon
    config (Event ID 17 and Event ID 18). The basic configuration is in popular sysmon
    configuration (https://github.com/SwiftOnSecurity/sysmon-config), but it is worth
    verifying. You can also use other repo, e.g. https://github.com/Neo23x0/sysmon-config,
    https://github.com/olafhartong/sysmon-modular. How to test detection? You can
    check powershell script from this site https://svch0st.medium.com/guide-to-named-pipes-and-hunting-for-cobalt-strike-pipes-dc46b2c5f575'
detection:
  selection:
    PipeName|contains: '\csexecsvc'
  condition: selection
falsepositives:
- Legitimate Administrator activity
level: medium
notes: |
  n
  ### Technical Context
  This Sigma rule is designed to detect the creation of named pipes associated with the “CSExec” service, which is a component commonly used by Cobalt Strike and other legitimate administrative tools for lateral movement and remote command execution. When an adversary uses Cobalt Strike, they typically create a named pipe named `csexecsvc` to communicate with the system. The rule monitors Windows Sysmon events specifically for created named pipes (Event ID 17) to identify entries containing this named pipe pattern. It falls under the MITRE ATT&CK tactic of Lateral Movement and technique T1021.002 (Remote Services 
  - Windows Admin Shares), which indicates potential misuse of administrative tools in the environment.
  To effectively utilize this rule, organizations must ensure Sysmon is correctly configured to capture named pipe events. Detailed logging from Sysmon will provide the necessary telemetry for detecting potential malicious activity while also reducing false alarms from legitimate administrative tasks.
  ### Investigation Steps
  - **Review Alerts in SIEM:** Begin by examining the alerts generated by this rule in the SIEM for any instances of named pipes created with the title `csexecsvc`. 
  - **Correlate with Process Creation:** Use EDR tools to track the process creation associated with the detected named pipe events, specifically noting any unusual parent-child relationships that may indicate lateral movement.
  - **Inspect Network Connections:** Check network logs via NDR or firewall logs for any associated network connections that were established at the time of the named pipe creation. This helps verify whether there was unauthorized data exfiltration or command and control communication.
  - **Engage User Context:** Review Windows Security logs to ascertain the user context and permissions of the process that created the named pipe. This can help determine if the activity was legitimate administrative use or indicative of malicious behavior.
  ### Prioritization
  The medium severity level of this alert indicates that while this activity could represent normal administrative action, it also has the potential for abuse. Investigating this alert is crucial because it may signify an attempt at lateral movement or the use of unauthorized tools within the enterprise environment.
  ### Blind spots and Assumptions
  This rule assumes that Sysmon logging is properly configured to capture named pipe creation events, specifically Event IDs 17 and 18. If Sysmon is not installed or improperly configured, the rule will not trigger on relevant activities. Additionally, legitimate administrative tasks may cause false positives; it is essential to differentiate between benign and malicious uses of named pipes. Attackers might also employ different or custom-named pipes to evade detection, which could also prevent this rule from firing. Hence, a comprehensive understanding of normal administrative behaviors within the environment is critical for effective investigation.
  > **Disclaimer:** This investigation guide was created using generative AI technology and has not been reviewed for its accuracy and relevance. While every effort has been made to ensure its quality, we recommend validating the content and adapting it to suit specific environment and operational needs. Please communicate any changes to the detection engineering team.
