title: File Decryption Using Gpg4win
id: 037dcd71-33a8-4392-bb01-293c94663e5a
status: test
description: Detects usage of Gpg4win to decrypt files
references:
- https://blogs.vmware.com/security/2022/11/batloader-the-evasive-downloader-malware.html
- https://www.gpg4win.de/documentation.html
- https://news.sophos.com/en-us/2022/01/19/zloader-installs-remote-access-backdoors-and-delivers-cobalt-strike/
author: Nasreddine Bencherchali (Nextron Systems)
date: 2023-08-09
tags:
- attack.execution
logsource:
  category: process_creation
  product: windows
detection:
  selection_metadata:
  - Image|endswith:
    - \gpg.exe
    - \gpg2.exe
  - Description: "GnuPG\u2019s OpenPGP tool"
  selection_cli:
    CommandLine|contains|all:
    - ' -d '
    - passphrase
  condition: all of selection_*
falsepositives:
- Unknown
level: medium
notes: |
  ### LLM Investigation Guide Notice
  This guide has been generated entirely with the use of an LLM and may include incorrect information, this guide will be
  reviewed in the future for accuracy.

  ### Technical Context
  The detection rule identifies the usage of Gpg4win, specifically its GPG components, to decrypt files, which can be
  indicative of malicious activity, particularly in the context of ransomware or data exfiltration. Gpg4win is a
  legitimate software suite that implements the OpenPGP standard and is often used for secure data encryption and signing.
  However, its functionalities can be exploited by attackers to obfuscate their activities, especially when combined with
  techniques like the use of stolen passphrases for decryption. Understanding the legitimate use of Gpg4win in an
  enterprise environment is critical for minimizing false positives while effectively identifying potential threats.

  ### Investigation Steps
  1. **Collect EDR Alerts**: Review alerts generated by the EDR system for anomalous activities related to Gpg4win,
  focusing on process creation events corresponding to `gpg.exe` or `gpg2.exe` executions.
  2. **Analyze Command Line Parameters**: Investigate the command line arguments passed during the execution of Gpg4win
  tools, specifically looking for usage patterns involving `-d` and any mention of "passphrase" which indicates decryption
  attempts.
  3. **Review AV Logs**: Check antivirus logs for any detections related to known malware or potentially unwanted
  applications that could be utilizing Gpg4win for nefarious purposes, including associations with known threats such as
  ZLoader and Cobalt Strike.
  4. **Examine Proxy Logs**: Analyze proxy logs for any unusual outbound connections or file downloads that coincide with
  the timestamps of Gpg4win usage, identifying potential command and control communications or data leakage.
